<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cia de Condimentos e Especiarias</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --amarelo: #F5C518;
    --amarelo-escuro: #D4A017;
    --vermelho: #C0392B;
    --vermelho-escuro: #922B21;
    --creme: #FFF8E7;
    --marrom: #3E2723;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', sans-serif; background: var(--creme); color: var(--marrom); }

  header { background: var(--vermelho); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .header-top { background: var(--amarelo); text-align: center; padding: 6px; font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--vermelho-escuro); }
  .header-main { display: flex; align-items: center; justify-content: space-between; padding: 16px 40px; }
  .logo-wrap { display: flex; align-items: center; gap: 12px; }
  .logo-icon { height: 50px; width: auto; object-fit: contain; border-radius: 8px; }
  .logo-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--amarelo); line-height: 1.1; }
  .logo-sub { font-size: 10px; color: rgba(255,255,255,0.6); letter-spacing: 4px; text-transform: uppercase; }
  nav a { color: #fff; text-decoration: none; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 6px 12px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  nav a:hover { border-color: var(--amarelo); color: var(--amarelo); }
  .cart-btn { position: relative; background: var(--amarelo); color: var(--vermelho); border: none; padding: 10px 24px; font-weight: 700; font-size: 14px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; letter-spacing: 1px; }
  .cart-btn:hover { background: var(--amarelo-escuro); }
  .cart-badge { position: absolute; top: -8px; right: -8px; background: var(--vermelho); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 900; }

  .hero { background: linear-gradient(135deg, var(--vermelho) 0%, var(--vermelho-escuro) 50%, #1a0a00 100%); padding: 80px 40px; text-align: center; position: relative; overflow: hidden; }
  .hero::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23F5C518' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E") repeat; }
  .hero-content { position: relative; z-index: 1; }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: 56px; color: var(--amarelo); font-weight: 900; line-height: 1.1; text-shadow: 2px 4px 20px rgba(0,0,0,0.4); }
  .hero p { color: rgba(255,255,255,0.85); font-size: 18px; margin-top: 16px; font-weight: 300; letter-spacing: 1px; }
  .hero-btn { display: inline-block; margin-top: 32px; background: var(--amarelo); color: var(--vermelho); padding: 16px 48px; font-weight: 900; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; border-radius: 4px; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .hero-btn:hover { background: var(--amarelo-escuro); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

  .filter-bar { background: var(--marrom); padding: 16px 40px; display: flex; align-items: center; gap: 12px; overflow-x: auto; }
  .filter-label { color: var(--amarelo); font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; white-space: nowrap; }
  .filter-btn { background: transparent; border: 1px solid rgba(245,197,24,0.3); color: rgba(255,255,255,0.7); padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
  .filter-btn:hover, .filter-btn.active { background: var(--amarelo); color: var(--marrom); border-color: var(--amarelo); font-weight: 700; }
  .search-input { flex: 1; max-width: 300px; padding: 8px 16px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 14px; outline: none; margin-left: auto; }
  .search-input::placeholder { color: rgba(255,255,255,0.4); }

  .section-title { text-align: center; padding: 60px 40px 40px; }
  .section-title h2 { font-family: 'Playfair Display', serif; font-size: 36px; color: var(--vermelho); font-weight: 700; }
  .section-title .line { width: 60px; height: 4px; background: var(--amarelo); margin: 12px auto 0; border-radius: 2px; }

  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 28px; padding: 0 40px 60px; max-width: 1400px; margin: 0 auto; }

  .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: all 0.3s; position: relative; }
  .product-card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,0,0,0.16); }
  .product-img { width: 100%; height: 220px; background: #f0e8d0; display: flex; align-items: center; justify-content: center; font-size: 60px; overflow: hidden; }
  .product-img img { width: 100%; height: 100%; object-fit: cover; }
  .stock-badge { position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .stock-ok { background: #27ae60; color: white; }
  .stock-low { background: var(--amarelo); color: var(--marrom); }
  .stock-out { background: #666; color: white; }
  .product-body { padding: 20px; }
  .product-category { font-size: 11px; font-weight: 700; color: var(--amarelo-escuro); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
  .product-name { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--marrom); margin-bottom: 8px; line-height: 1.3; }
  .product-desc { font-size: 13px; color: #888; line-height: 1.5; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .product-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0e8d0; padding-top: 16px; }
  .product-price { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--vermelho); }
  .product-price span { font-size: 13px; font-weight: 400; color: #aaa; display: block; }
  .add-cart-btn { background: var(--vermelho); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
  .add-cart-btn:hover { background: var(--vermelho-escuro); transform: scale(1.05); }
  .add-cart-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

  .cart-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; }
  .cart-overlay.open { display: block; }
  .cart-sidebar { position: fixed; top: 0; right: -500px; width: 440px; height: 100vh; background: white; z-index: 201; display: flex; flex-direction: column; transition: right 0.3s; box-shadow: -8px 0 40px rgba(0,0,0,0.2); }
  .cart-sidebar.open { right: 0; }
  .cart-header { background: var(--vermelho); color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
  .cart-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .cart-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
  .cart-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f0e8d0; }
  .cart-item-img { width: 70px; height: 70px; background: #f0e8d0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 28px; overflow: hidden; flex-shrink: 0; }
  .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-weight: 700; font-size: 15px; color: var(--marrom); }
  .cart-item-price { color: var(--vermelho); font-weight: 700; font-size: 16px; margin-top: 4px; }
  .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  .qty-btn { background: var(--amarelo); border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: 900; cursor: pointer; font-size: 16px; transition: background 0.2s; }
  .qty-btn:hover { background: var(--amarelo-escuro); }
  .qty-val { font-weight: 700; font-size: 16px; min-width: 24px; text-align: center; }
  .remove-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
  .remove-btn:hover { color: var(--vermelho); }
  .cart-footer { padding: 20px; border-top: 2px solid #f0e8d0; }
  .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; margin-bottom: 16px; font-family: 'Playfair Display', serif; }
  .cart-total span:last-child { color: var(--vermelho); }
  .checkout-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-size: 16px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
  .checkout-btn:hover { background: var(--vermelho-escuro); }
  .empty-cart { text-align: center; padding: 60px 20px; color: #aaa; }
  .empty-cart .icon { font-size: 60px; display: block; margin-bottom: 16px; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 12px; max-width: 560px; width: 100%; overflow: hidden; animation: modalIn 0.3s ease; }
  @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .modal-header { background: var(--vermelho); padding: 24px 28px; color: white; display: flex; justify-content: space-between; align-items: center; }
  .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .modal-body { padding: 28px; max-height: 80vh; overflow-y: auto; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; color: var(--marrom); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
  .form-group input, .form-group select { width: 100%; padding: 10px 14px; border: 2px solid #e0d8c8; border-radius: 4px; font-size: 14px; font-family: 'Lato', sans-serif; transition: border-color 0.2s; outline: none; }
  .form-group input:focus, .form-group select:focus { border-color: var(--amarelo); }
  .order-summary { background: var(--creme); border-radius: 8px; padding: 16px; margin-bottom: 20px; }
  .order-summary h4 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; margin-bottom: 10px; color: var(--vermelho); }
  .summary-item { display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; }
  .summary-total { display: flex; justify-content: space-between; font-weight: 900; font-size: 16px; border-top: 2px solid var(--amarelo); padding-top: 10px; margin-top: 8px; }
  .submit-order-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-size: 16px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
  .submit-order-btn:hover { background: var(--vermelho-escuro); }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--marrom); color: white; padding: 14px 28px; border-radius: 8px; font-weight: 700; font-size: 14px; z-index: 500; transition: transform 0.3s; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .auth-btn { margin-left: 12px; background: transparent; color: white; border: 2px solid rgba(255,255,255,0.12); padding: 8px 14px; border-radius: 6px; font-weight:700; cursor: pointer; }
  .auth-btn:hover { background: rgba(255,255,255,0.04); }
  .user-badge { background: var(--amarelo); color: var(--vermelho); padding: 8px 12px; border-radius: 20px; font-weight:900; }

  footer { background: var(--marrom); color: rgba(255,255,255,0.6); text-align: center; padding: 32px; font-size: 13px; }
  footer .brand { font-family: 'Playfair Display', serif; color: var(--amarelo); font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .no-products { text-align: center; padding: 80px 20px; color: #aaa; grid-column: 1/-1; }
  .no-products .icon { font-size: 60px; display: block; margin-bottom: 16px; }
  .success-screen { text-align: center; padding: 40px 20px; }
  .success-screen .icon { font-size: 70px; display: block; margin-bottom: 16px; }
  .success-screen h3 { font-family: 'Playfair Display', serif; font-size: 26px; color: var(--vermelho); margin-bottom: 10px; }
  .success-screen .order-code { font-size: 22px; font-weight: 900; color: var(--amarelo-escuro); margin: 16px 0; background: var(--creme); padding: 10px; border-radius: 8px; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-sidebar" id="cartSidebar">
  <div class="cart-header">
    <h3>🛒 Seu Carrinho</h3>
    <button class="cart-close" onclick="toggleCart()">✕</button>
  </div>
  <div class="cart-items" id="cartItems"></div>
  <div class="cart-footer">
    <div class="cart-total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
    <button class="checkout-btn" onclick="openCheckout()">Finalizar Compra</button>
  </div>
</div>

<div class="modal-overlay" id="checkoutModal">
  <div class="modal">
    <div class="modal-header">
      <h3>🌶️ Finalizar Pedido</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeCheckout()">✕</button>
    </div>
    <div class="modal-body" id="checkoutBody"></div>
  </div>
</div>

<div class="modal-overlay" id="authModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="authTitle">🔐 Entrar / Cadastrar</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeAuth()">✕</button>
    </div>
    <div class="modal-body">
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0d8c8; padding-bottom: 10px;">
        <button id="tabLogin" style="flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: var(--vermelho);" onclick="showAuthTab('login')">🔓 Entrar</button>
        <button id="tabRegister" style="flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: #aaa; opacity: 0.7;" onclick="showAuthTab('register')">➕ Cadastrar</button>
      </div>
      <div id="authContent"></div>
    </div>
  </div>
</div>
  </div>
</div>

<header>
  <div class="header-top">✦ FRETE GRÁTIS A PARTIR DE R$ 50 - ABAIXO DISSO, TAXA DE R$ 10 POR ENTREGA ✦ CONDIMENTOS E ESPECIARIAS ✦</div>
  <div class="header-main">
    <div class="logo-wrap">
      <div>
        <div class="logo-title">Cia de<br>Condimentos</div>
        <div class="logo-sub">Especiarias Premium</div>
      </div>
    </div>
    <nav>
      <a href="#inicio">Início</a>
      <a href="#produtos">Produtos</a>
      <a href="#contato">Contato</a>
    </nav>
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="cart-btn" onclick="toggleCart()">🛒 Carrinho <span class="cart-badge" id="cartBadge">0</span></button>
      <button class="auth-btn" id="authBtn" onclick="openAuth()">Entrar / Cadastrar</button>
    </div>
  </div>
</header>

<section class="hero" id="inicio">
  <div class="hero-content">
    <h1>Sabores do Mundo</h1>
    <p>Experimente os melhores condimentos e especiarias selecionados com excelência</p>
    <button class="hero-btn" onclick="document.getElementById('produtos').scrollIntoView({ behavior: 'smooth' })">Comprar Agora</button>
  </div>
</section>

<section class="filter-bar" id="produtos">
  <span class="filter-label">Filtrar:</span>
  <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
  <button class="filter-btn" onclick="filterProducts('Pimentas', this)">Pimentas</button>
  <button class="filter-btn" onclick="filterProducts('Especiarias', this)">Especiarias</button>
  <button class="filter-btn" onclick="filterProducts('Ervas', this)">Ervas</button>
  <button class="filter-btn" onclick="filterProducts('Temperos', this)">Temperos</button>
  <button class="filter-btn" onclick="filterProducts('Molhos', this)">Molhos</button>
  <input type="text" class="search-input" id="searchInput" placeholder="Buscar produtos..." onkeyup="handleSearch(this.value)">
</section>

<section class="section-title">
  <h2>Nossos Produtos</h2>
  <div class="line"></div>
</section>

<div class="products-grid" id="productsGrid"></div>

<footer>
  <div class="brand">Cia de Condimentos</div>
  <p>© 2026 Todos os direitos reservados | Condimentos e Especiarias Premium</p>
</footer>

<script>
// Detectar ambiente e definir URL da API corretamente
function getApiUrl() {
  const hostname = window.location.hostname;
  if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('localhost')) {
    return 'http://localhost:3000/api';
  }
  // Em produção, usar URL da API no Render
  return 'https://cia-condimentos.onrender.com/api';
}

const API_URL = getApiUrl();
let cart = [], currentFilter = 'all', currentSearch = '', currentUser = null;

// API Calls
async function getProducts() {
  try {
    const response = await fetch(`${API_URL}/products`);
    if (response.ok) {
      const products = await response.json();
      return products.map(p => ({ ...p, price: parseFloat(p.price) || 0 }));
    }
  } catch (e) {
    console.error('Erro ao buscar produtos:', e);
    showToast('⚠️ Erro ao carregar produtos');
  }
  return [];
}

async function submitOrderToAPI(orderData) {
  try {
    const response = await fetch(`${API_URL}/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    });
    if (response.ok) return await response.json();
    throw new Error('Falha ao salvar pedido');
  } catch (e) {
    console.error('Erro ao salvar pedido:', e);
    showToast('⚠️ Erro ao processar pedido');
  }
  return null;
}

async function registerUser(name, email, password) {
  try {
    const response = await fetch(`${API_URL}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password })
    });
    if (response.ok) return await response.json();
    const error = await response.json();
    throw new Error(error.message || 'Erro no cadastro');
  } catch (e) {
    showToast('⚠️ ' + e.message);
  }
  return null;
}

async function loginUser(email, password) {
  try {
    const response = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    if (response.ok) return await response.json();
    const error = await response.json();
    throw new Error(error.message || 'Erro no login');
  } catch (e) {
    showToast('⚠️ ' + e.message);
  }
  return null;
}

function setCurrentUser(u) { 
  currentUser = u; 
  updateAuthUI(); 
}

function clearCurrentUser() { 
  currentUser = null; 
  updateAuthUI(); 
}

function getCurrentUser() { 
  return currentUser; 
}

function toggleCart() {
  const sidebar = document.getElementById('cartSidebar');
  const overlay = document.getElementById('cartOverlay');
  if (sidebar && overlay) {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
    renderCart();
  }
}

async function addToCart(id) {
  const products = (await getProducts()).filter(p => p.active);
  const product = products.find(p => p.id === id);
  if (!product || product.stock <= 0) return;
  const existing = cart.find(i => i.id === id);
  if (existing) {
    if (existing.qty >= product.stock) { showToast('⚠️ Quantidade máxima em estoque!'); return; }
    existing.qty++;
  } else {
    cart.push({ id: product.id, name: product.name, price: product.price, qty: 1, image: product.image, category: product.category });
  }
  updateCartBadge();
  showToast('🌶️ "' + product.name + '" adicionado ao carrinho!');
  renderCart();
}

function removeFromCart(id) { cart = cart.filter(i => i.id !== id); updateCartBadge(); renderCart(); }

async function changeQty(id, delta) {
  const item = cart.find(i => i.id === id);
  if (!item) return;
  const products = await getProducts();
  const product = products.find(p => p.id === id);
  item.qty = Math.max(1, Math.min(item.qty + delta, product ? product.stock : 99));
  updateCartBadge(); renderCart();
}

function updateCartBadge() { 
  const badge = document.getElementById('cartBadge');
  if (badge) badge.textContent = cart.reduce((s, i) => s + i.qty, 0);
}
function getCartTotal() { return cart.reduce((s, i) => s + i.price * i.qty, 0); }
function fmt(v) { 
  const num = parseFloat(v);
  return isNaN(num) ? 'R$ 0,00' : 'R$ ' + num.toFixed(2).replace('.', ','); 
}

function renderCart() {
  const container = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  if (!container || !totalEl) return;
  totalEl.textContent = fmt(getCartTotal());
  if (cart.length === 0) { container.innerHTML = '<div class="empty-cart"><span class="icon">🛒</span><p>Seu carrinho está vazio</p></div>'; return; }
  container.innerHTML = cart.map(item => `
    <div class="cart-item">
      <div class="cart-item-img">${item.image ? '<img src="'+item.image+'" alt="'+item.name+'" onerror="this.parentElement.innerHTML=\'🌶️\'">' : '🌶️'}</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${item.name}</div>
        <div class="cart-item-price">${fmt(item.price * item.qty)}</div>
        <div class="qty-controls">
          <button class="qty-btn" onclick="changeQty(${item.id},-1)">−</button>
          <span class="qty-val">${item.qty}</span>
          <button class="qty-btn" onclick="changeQty(${item.id},1)">+</button>
          <button class="remove-btn" onclick="removeFromCart(${item.id})">🗑️</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function filterProducts(category, button) {
  currentFilter = category;
  if (button) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    button.classList.add('active');
  }
  await renderProducts();
}

async function handleSearch(query) {
  currentSearch = query.toLowerCase();
  await renderProducts();
}

async function renderProducts() {
  const products = await getProducts();
  let filtered = products.filter(p => p.active && (currentFilter === 'all' || p.category === currentFilter));
  
  if (currentSearch) {
    filtered = filtered.filter(p => 
      p.name.toLowerCase().includes(currentSearch) || 
      p.description.toLowerCase().includes(currentSearch)
    );
  }
  
  const container = document.getElementById('productsGrid');
  if (!container) {
    console.error('Elemento productsGrid não encontrado no DOM');
    return;
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="no-products"><span class="icon">🌶️</span><p>Nenhum produto disponível nesta categoria</p></div>';
    return;
  }
  
  container.innerHTML = filtered.map(p => `
    <div class="product-card">
      <div class="product-img">${p.image ? '<img src="'+p.image+'" alt="'+p.name+'" onerror="this.parentElement.innerHTML=\'🌶️\'">' : '<div class="placeholder">🌶️</div>'}</div>
      <div class="product-body">
        <div class="product-category">${p.category}</div>
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.description}</div>
        <div class="product-footer">
          <div class="product-price">${fmt(p.price)}</div>
          <button class="add-cart-btn ${p.stock <= 0 ? 'disabled' : ''}" onclick="${p.stock > 0 ? 'addToCart(' + p.id + ')' : ''}" ${p.stock <= 0 ? 'disabled' : ''}>
            ${p.stock > 0 ? '🛒 Adicionar' : '❌ Indisponível'}
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function openCheckout() {
  if (cart.length === 0) { showToast('Adicione produtos ao carrinho!'); return; }
  const total = getCartTotal();
  const frete = total >= 50 ? 0 : 10.00;
  const checkoutBody = document.getElementById('checkoutBody');
  if (!checkoutBody) return;
  checkoutBody.innerHTML = `
    <div class="order-summary">
      <h4>📋 Resumo do Pedido</h4>
      ${cart.map(i => `<div class="summary-item"><span>${i.name} x${i.qty}</span><span>${fmt(i.price*i.qty)}</span></div>`).join('')}
      <div class="summary-item"><span>Frete</span><span>${frete===0?'🎉 Grátis':fmt(frete)}</span></div>
      <div class="summary-total"><span>Total</span><span style="color:var(--vermelho)">${fmt(total+frete)}</span></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Nome Completo</label><input type="text" id="cName" placeholder="Seu nome completo"></div>
      <div class="form-group"><label>E-mail</label><input type="email" id="cEmail" placeholder="email@exemplo.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Telefone</label><input type="text" id="cPhone" placeholder="(00) 00000-0000"></div>
      <div class="form-group"><label>CPF</label><input type="text" id="cCpf" placeholder="000.000.000-00"></div>
    </div>
    <div class="form-group"><label>Endereço Completo</label><input type="text" id="cAddress" placeholder="Rua, número, bairro, complemento"></div>
    <div class="form-row">
      <div class="form-group"><label>Cidade / Estado</label><input type="text" id="cCity" placeholder="Cidade - UF"></div>
      <div class="form-group"><label>CEP</label><input type="text" id="cCep" placeholder="00000-000"></div>
    </div>
    <div class="form-group">
      <label>Forma de Pagamento</label>
      <select id="cPayment"><option value="PIX">PIX</option><option value="Cartão de Crédito">Cartão de Crédito</option><option value="Cartão de Débito">Cartão de Débito</option><option value="Boleto">Boleto Bancário</option></select>
    </div>
    <button class="submit-order-btn" onclick="submitOrder(${frete})">✅ Confirmar Pedido</button>
  `;
  const modal = document.getElementById('checkoutModal');
  if (modal) modal.classList.add('open');
}

function closeCheckout() { 
  const modal = document.getElementById('checkoutModal');
  if (modal) modal.classList.remove('open');
}

async function submitOrder(frete) {
  const name = document.getElementById('cName').value.trim();
  const email = document.getElementById('cEmail').value.trim();
  const phone = document.getElementById('cPhone').value.trim();
  const cpf = document.getElementById('cCpf').value.trim();
  const address = document.getElementById('cAddress').value.trim();
  const city = document.getElementById('cCity').value.trim();
  const cep = document.getElementById('cCep').value.trim();
  const payment = document.getElementById('cPayment').value;

  if (!name || !email || !phone || !address || !city || !cep) { 
    showToast('⚠️ Preencha todos os campos obrigatórios!'); 
    return; 
  }

  const total = getCartTotal();
  const orderData = {
    customer: { name, email, phone, cpf, address: address + ', ' + city + ', CEP ' + cep },
    items: [...cart], 
    subtotal: total, 
    frete, 
    total: total + frete, 
    payment,
    status: 'Pendente', 
    paymentStatus: 'Aguardando'
  };
  
  const result = await submitOrderToAPI(orderData);
  if (!result) return;

  // Salvar cliente no admin
  const existingCustomers = JSON.parse(localStorage.getItem('cia_customers') || '[]');
  const customerExists = existingCustomers.some(c => c.email === name_client);
  if (!customerExists) {
    existingCustomers.push({
      id: Date.now(),
      name: name_client,
      email: name_client,
      phone: phone,
      cpf: cpf,
      address: address,
      created_at: new Date().toISOString()
    });
    localStorage.setItem('cia_customers', JSON.stringify(existingCustomers));
  }
  
  const orderId = result.id;
  cart = [];
  updateCartBadge();

  const checkoutBody = document.getElementById('checkoutBody');
  if (checkoutBody) {
    checkoutBody.innerHTML = `
      <div class="success-screen">
        <span class="icon">🎉</span>
        <h3>Pedido Confirmado!</h3>
        <div class="order-code">${orderId}</div>
        <p>Obrigado pela compra! Você receberá um e-mail de confirmação em breve.</p>
        <button class="submit-order-btn" onclick="closeCheckout(); renderProducts();">Voltar às Compras</button>
      </div>
    `;
  }
  showToast('✅ Pedido realizado com sucesso!');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function openAuth() { 
  showAuthTab('login'); 
  const modal = document.getElementById('authModal');
  if (modal) modal.classList.add('open');
}

function closeAuth() { 
  const modal = document.getElementById('authModal');
  if (modal) modal.classList.remove('open');
}

function showAuthTab(tab) {
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const c = document.getElementById('authContent');
  
  if (!c) return;
  
  if (tabLogin) {
    tabLogin.style.opacity = tab === 'login' ? '1' : '0.7';
    tabLogin.style.borderBottomColor = tab === 'login' ? 'var(--vermelho)' : 'transparent';
    tabLogin.style.color = tab === 'login' ? 'var(--vermelho)' : '#aaa';
  }
  if (tabRegister) {
    tabRegister.style.opacity = tab === 'register' ? '1' : '0.7';
    tabRegister.style.borderBottomColor = tab === 'register' ? 'var(--amarelo)' : 'transparent';
    tabRegister.style.color = tab === 'register' ? 'var(--vermelho)' : '#aaa';
  }
  
  if (tab === 'login') {
    c.innerHTML = `
      <div class="form-group"><label>E-mail</label><input type="email" id="aEmail" placeholder="seu@exemplo.com"></div>
      <div class="form-group"><label>Senha</label><input type="password" id="aPassword" placeholder="••••••••"></div>
      <div style="display:flex;gap:10px;margin-top:20px;"><button onclick="doLogin()" style="flex:1;background:var(--vermelho);color:white;padding:12px;border-radius:6px;border:none;font-weight:800;cursor:pointer;">🔓 Entrar</button><button onclick="showAuthTab('register')" style="flex:1;border:2px solid #eee;padding:12px;border-radius:6px;background:#fff;font-weight:700;cursor:pointer;">Criar Conta →</button></div>
    `;
  } else {
    c.innerHTML = `
      <div class="form-group"><label>Nome Completo</label><input type="text" id="rName" placeholder="Seu nome"></div>
      <div class="form-group"><label>E-mail</label><input type="email" id="rEmail" placeholder="seu@exemplo.com"></div>
      <div class="form-group"><label>Senha</label><input type="password" id="rPassword" placeholder="••••••••"></div>
      <div class="form-group"><label>Confirmar Senha</label><input type="password" id="rPassword2" placeholder="••••••••"></div>
      <div style="display:flex;gap:10px;margin-top:20px;"><button onclick="doRegister()" style="flex:1;background:var(--amarelo);color:var(--vermelho);padding:12px;border-radius:6px;border:none;font-weight:800;cursor:pointer;">✅ Cadastrar</button><button onclick="showAuthTab('login')" style="flex:1;border:2px solid #eee;padding:12px;border-radius:6px;background:#fff;font-weight:700;cursor:pointer;">← Voltar</button></div>
    `;
  }
}

async function doRegister() {
  const name = document.getElementById('rName').value.trim();
  const email = document.getElementById('rEmail').value.trim().toLowerCase();
  const pass = document.getElementById('rPassword').value;
  const pass2 = document.getElementById('rPassword2').value;
  if (!name || !email || !pass) { showToast('Preencha todos os campos.'); return; }
  if (pass !== pass2) { showToast('As senhas não coincidem.'); return; }
  
  const user = await registerUser(name, email, pass);
  if (user) {
    // Salvar cliente no localStorage do admin
    const existingCustomers = JSON.parse(localStorage.getItem('cia_customers') || '[]');
    const customerExists = existingCustomers.some(c => c.email === email);
    if (!customerExists) {
      existingCustomers.push({
        id: Date.now(),
        name: name,
        email: email,
        phone: '',
        cpf: '',
        address: '',
        created_at: new Date().toISOString()
      });
      localStorage.setItem('cia_customers', JSON.stringify(existingCustomers));
    }
    
    setCurrentUser({ name: user.user?.name || name, email: user.user?.email || email });
    showToast('✅ Conta criada com sucesso!');
    closeAuth();
  }
}

async function doLogin() {
  const email = (document.getElementById('aEmail').value || '').trim().toLowerCase();
  const pass = document.getElementById('aPassword').value || '';
  if (!email || !pass) { showToast('Preencha e-mail e senha.'); return; }
  
  const user = await loginUser(email, pass);
  if (user) {
    // Salvar cliente no localStorage do admin se não existir
    const existingCustomers = JSON.parse(localStorage.getItem('cia_customers') || '[]');
    const customerExists = existingCustomers.some(c => c.email === email);
    if (!customerExists) {
      existingCustomers.push({
        id: Date.now(),
        name: user.user?.name || email.split('@')[0],
        email: email,
        phone: '',
        cpf: '',
        address: '',
        created_at: new Date().toISOString()
      });
      localStorage.setItem('cia_customers', JSON.stringify(existingCustomers));
    }
    
    setCurrentUser({ name: user.user?.name || email, email: user.user?.email || email });
    showToast('✅ Login realizado!');
    closeAuth();
  }
}

function doLogout() { clearCurrentUser(); showToast('Desconectado.'); }

function updateAuthUI() {
  const container = document.getElementById('authBtn');
  const user = getCurrentUser();
  if (!container) return;
  if (user) {
    container.outerHTML = `<div class="user-badge" id="userBadge">Olá, ${escapeHtml(user.name.split(' ')[0] || user.email)} <button style="margin-left:10px;background:none;border:none;cursor:pointer;font-weight:700;" onclick="doLogout()">Sair</button></div>`;
  } else {
    if (!document.getElementById('authBtn')) {
      const after = document.querySelector('.cart-btn');
      if (after) { after.insertAdjacentHTML('afterend', '<button class="auth-btn" id="authBtn" onclick="openAuth()">Entrar / Cadastrar</button>'); }
    }
  }
}

function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]); }

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
  renderProducts();
  updateAuthUI();
});
</script>
</body>
</html>
