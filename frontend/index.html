<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cia de Condimentos e Especiarias</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --amarelo: #F5C518;
    --amarelo-escuro: #D4A017;
    --vermelho: #C0392B;
    --vermelho-escuro: #922B21;
    --creme: #FFF8E7;
    --marrom: #3E2723;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', sans-serif; background: var(--creme); color: var(--marrom); }

  header { background: var(--vermelho); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .header-top { background: var(--amarelo); text-align: center; padding: 6px; font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--vermelho-escuro); }
  .header-main { display: flex; align-items: center; justify-content: space-between; padding: 16px 40px; }
  .logo-wrap { display: flex; align-items: center; gap: 12px; }
  .logo-icon { height: 50px; width: auto; object-fit: contain; border-radius: 8px; }
  .logo-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--amarelo); line-height: 1.1; }
  .logo-sub { font-size: 10px; color: rgba(255,255,255,0.6); letter-spacing: 4px; text-transform: uppercase; }
  nav a { color: #fff; text-decoration: none; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 6px 12px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  nav a:hover { border-color: var(--amarelo); color: var(--amarelo); }
  .cart-btn { position: relative; background: var(--amarelo); color: var(--vermelho); border: none; padding: 10px 24px; font-weight: 700; font-size: 14px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; letter-spacing: 1px; }
  .cart-btn:hover { background: var(--amarelo-escuro); }
  .cart-badge { position: absolute; top: -8px; right: -8px; background: var(--vermelho); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 900; }

  .hero { background: linear-gradient(135deg, var(--vermelho) 0%, var(--vermelho-escuro) 50%, #1a0a00 100%); padding: 80px 40px; text-align: center; position: relative; overflow: hidden; }
  .hero::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23F5C518' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E") repeat; }
  .hero-content { position: relative; z-index: 1; }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: 56px; color: var(--amarelo); font-weight: 900; line-height: 1.1; text-shadow: 2px 4px 20px rgba(0,0,0,0.4); }
  .hero p { color: rgba(255,255,255,0.85); font-size: 18px; margin-top: 16px; font-weight: 300; letter-spacing: 1px; }
  .hero-btn { display: inline-block; margin-top: 32px; background: var(--amarelo); color: var(--vermelho); padding: 16px 48px; font-weight: 900; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; border-radius: 4px; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .hero-btn:hover { background: var(--amarelo-escuro); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

  .filter-bar { background: var(--marrom); padding: 16px 40px; display: flex; align-items: center; gap: 12px; overflow-x: auto; }
  .filter-label { color: var(--amarelo); font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; white-space: nowrap; }
  .filter-btn { background: transparent; border: 1px solid rgba(245,197,24,0.3); color: rgba(255,255,255,0.7); padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
  .filter-btn:hover, .filter-btn.active { background: var(--amarelo); color: var(--marrom); border-color: var(--amarelo); font-weight: 700; }
  .search-input { flex: 1; max-width: 300px; padding: 8px 16px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 14px; outline: none; margin-left: auto; }
  .search-input::placeholder { color: rgba(255,255,255,0.4); }

  .section-title { text-align: center; padding: 60px 40px 40px; }
  .section-title h2 { font-family: 'Playfair Display', serif; font-size: 36px; color: var(--vermelho); font-weight: 700; }
  .section-title .line { width: 60px; height: 4px; background: var(--amarelo); margin: 12px auto 0; border-radius: 2px; }

  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 28px; padding: 0 40px 60px; max-width: 1400px; margin: 0 auto; }

  .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: all 0.3s; position: relative; }
  .product-card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,0,0,0.16); }
  .product-img { width: 100%; height: 220px; background: #f0e8d0; display: flex; align-items: center; justify-content: center; font-size: 60px; overflow: hidden; }
  .product-img img { width: 100%; height: 100%; object-fit: cover; }
  .product-body { padding: 20px; }
  .product-category { font-size: 11px; font-weight: 700; color: var(--amarelo-escuro); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
  .product-name { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--marrom); margin-bottom: 8px; line-height: 1.3; }
  .product-desc { font-size: 13px; color: #888; line-height: 1.5; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .product-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0e8d0; padding-top: 16px; }
  .product-price { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--vermelho); }
  .add-cart-btn { background: var(--vermelho); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
  .add-cart-btn:hover { background: var(--vermelho-escuro); transform: scale(1.05); }
  .add-cart-btn:disabled { background: #ccc; cursor: not-allowed; }

  .cart-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; }
  .cart-overlay.open { display: block !important; }
  .cart-sidebar { position: fixed; top: 0; right: 0; width: 440px; height: 100vh; background: white; z-index: 201; display: flex; flex-direction: column; transform: translateX(500px); transition: transform 0.3s ease-in-out; box-shadow: -8px 0 40px rgba(0,0,0,0.2); }
  .cart-sidebar.open { transform: translateX(0) !important; }
  .cart-header { background: var(--vermelho); color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
  .cart-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .cart-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
  .cart-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f0e8d0; }
  .cart-item-img { width: 70px; height: 70px; background: #f0e8d0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
  .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-weight: 700; font-size: 15px; color: var(--marrom); }
  .cart-item-price { color: var(--vermelho); font-weight: 700; font-size: 16px; margin-top: 4px; }
  .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  .qty-btn { background: var(--amarelo); border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: 900; cursor: pointer; }
  .qty-val { font-weight: 700; font-size: 16px; min-width: 24px; text-align: center; }
  .remove-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
  .cart-footer { padding: 20px; border-top: 2px solid #f0e8d0; }
  .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; margin-bottom: 16px; }
  .cart-total span:last-child { color: var(--vermelho); }
  .checkout-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; }
  .empty-cart { text-align: center; padding: 60px 20px; color: #aaa; }
  .empty-cart .icon { font-size: 60px; margin-bottom: 16px; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; display: none; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex !important; }
  .modal { background: white; border-radius: 12px; max-width: 560px; width: 100%; overflow: hidden; }
  .modal-header { background: var(--vermelho); padding: 24px 28px; color: white; display: flex; justify-content: space-between; align-items: center; }
  .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .modal-body { padding: 28px; max-height: 80vh; overflow-y: auto; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; color: var(--marrom); margin-bottom: 6px; }
  .form-group input { width: 100%; padding: 10px 14px; border: 2px solid #e0d8c8; border-radius: 4px; font-size: 14px; }
  .form-group input:focus { border-color: var(--amarelo); outline: none; }
  .submit-order-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; margin-top: 16px; }
  .submit-order-btn:hover { background: var(--vermelho-escuro); }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--marrom); color: white; padding: 14px 28px; border-radius: 8px; font-weight: 700; z-index: 500; transition: transform 0.3s; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .auth-btn { background: transparent; color: white; border: 2px solid rgba(255,255,255,0.12); padding: 8px 14px; border-radius: 6px; font-weight: 700; cursor: pointer; margin-left: 12px; }

  footer { background: var(--marrom); color: rgba(255,255,255,0.6); text-align: center; padding: 32px; font-size: 13px; }
  footer .brand { font-family: 'Playfair Display', serif; color: var(--amarelo); font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .no-products { text-align: center; padding: 80px 20px; color: #aaa; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>
<div class="cart-overlay" id="cartOverlay" onclick="if(event.target === this) toggleCart()"></div>
<div class="cart-sidebar" id="cartSidebar">
  <div class="cart-header">
    <h3>🛒 Seu Carrinho</h3>
    <button class="cart-close" onclick="toggleCart()">✕</button>
  </div>
  <div class="cart-items" id="cartItems"></div>
  <div class="cart-footer">
    <div class="cart-total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
    <button class="checkout-btn" onclick="openCheckout()">Finalizar Compra</button>
  </div>
</div>

<div class="modal-overlay" id="checkoutModal" onclick="if(event.target === this) closeCheckout()">
  <div class="modal" onclick="event.stopPropagation();">
    <div class="modal-header">
      <h3>🌶️ Finalizar Pedido</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeCheckout()">✕</button>
    </div>
    <div class="modal-body" id="checkoutBody"></div>
  </div>
</div>

<div class="modal-overlay" id="authModal" onclick="if(event.target === this) closeAuth()">
  <div class="modal" onclick="event.stopPropagation();">
    <div class="modal-header">
      <h3>🔐 Entrar / Cadastrar</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeAuth()">✕</button>
    </div>
    <div class="modal-body">
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0d8c8; padding-bottom: 10px;">
        <button id="tabLogin" style="flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; cursor: pointer; border-bottom: 3px solid var(--vermelho); color: var(--vermelho);" onclick="showAuthTab('login')">🔓 Entrar</button>
        <button id="tabRegister" style="flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: #aaa;" onclick="showAuthTab('register')">➕ Cadastrar</button>
      </div>
      <div id="authContent"></div>
    </div>
  </div>
</div>

<header>
  <div class="header-top">✦ FRETE GRÁTIS A PARTIR DE R$ 50 ✦</div>
  <div class="header-main">
    <div class="logo-wrap">
      <img src="img/logotipooficialciadecondimentos.png" alt="Cia de Condimentos" class="logo-icon" />
      <div>
        <div class="logo-title">Cia de Condimentos</div>
        <div class="logo-sub">Especiarias Premium</div>
      </div>
    </div>
    <nav>
      <a href="#inicio">Início</a>
      <a href="#produtos">Produtos</a>
      <a href="#contato">Contato</a>
    </nav>
    <div style="display:flex;align-items:center;">
      <button class="cart-btn" onclick="toggleCart()">🛒 Carrinho <span class="cart-badge" id="cartBadge">0</span></button>
      <button class="auth-btn" onclick="openAuth()">Entrar / Cadastrar</button>
    </div>
  </div>
</header>

<section class="hero" id="inicio">
  <div class="hero-content">
    <h1>Sabores do Mundo</h1>
    <p>Experimente os melhores condimentos e especiarias selecionados com excelência</p>
    <button class="hero-btn" onclick="document.getElementById('produtos').scrollIntoView({ behavior: 'smooth' })">Comprar Agora</button>
  </div>
</section>

<section class="filter-bar" id="produtos">
  <span class="filter-label">Filtrar:</span>
  <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
  <button class="filter-btn" onclick="filterProducts('Pimentas', this)">Pimentas</button>
  <button class="filter-btn" onclick="filterProducts('Especiarias', this)">Especiarias</button>
  <button class="filter-btn" onclick="filterProducts('Ervas', this)">Ervas</button>
  <input type="text" class="search-input" id="searchInput" placeholder="Buscar produtos..." onkeyup="handleSearch(this.value)">
</section>

<section class="section-title">
  <h2>Nossos Produtos</h2>
  <div class="line"></div>
</section>

<div class="products-grid" id="productsGrid"></div>

<footer>
  <div class="brand">Cia de Condimentos</div>
  <p>© 2026 Todos os direitos reservados</p>
</footer>

<script>
function getApiUrl() {
  const hostname = window.location.hostname;
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://localhost:3000/api';
  }
  return 'https://cia-condimentos.onrender.com/api';
}

function safeGetElement(id) {
  return document.getElementById(id);
}

const API_URL = getApiUrl();
let cart = [];
let currentFilter = 'all';
let currentSearch = '';

// Garantir que os modais sempre existem no DOM
function ensureModalsExist() {
  const cartSidebar = document.getElementById('cartSidebar');
  const authModal = document.getElementById('authModal');
  const checkoutModal = document.getElementById('checkoutModal');
  const cartOverlay = document.getElementById('cartOverlay');
  
  let missingElements = [];
  if (!cartSidebar) missingElements.push('cartSidebar');
  if (!authModal) missingElements.push('authModal');
  if (!checkoutModal) missingElements.push('checkoutModal');
  if (!cartOverlay) missingElements.push('cartOverlay');
  
  if (missingElements.length > 0) {
    console.error('❌ CRÍTICO: Os seguintes elementos desapareceram:', missingElements.join(', '));
    console.error('  Recriando modais...');
    
    // Recriar os modais no início do body
    const modalsHTML = `
<div id="toast" class="toast"></div>
<div class="cart-overlay" id="cartOverlay" onclick="if(event.target === this) toggleCart()"></div>
<div class="cart-sidebar" id="cartSidebar">
  <div class="cart-header">
    <h3>🛒 Seu Carrinho</h3>
    <button class="cart-close" onclick="toggleCart()">✕</button>
  </div>
  <div class="cart-items" id="cartItems"></div>
  <div class="cart-footer">
    <div class="cart-total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
    <button class="checkout-btn" onclick="openCheckout()">Finalizar Compra</button>
  </div>
</div>

<div class="modal-overlay" id="checkoutModal" onclick="if(event.target === this) closeCheckout()">
  <div class="modal" onclick="event.stopPropagation();">
    <div class="modal-header">
      <h3>🌶️ Finalizar Pedido</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeCheckout()">✕</button>
    </div>
    <div class="modal-body" id="checkoutBody"></div>
  </div>
</div>

<div class="modal-overlay" id="authModal" onclick="if(event.target === this) closeAuth()">
  <div class="modal" onclick="event.stopPropagation();">
    <div class="modal-header">
      <h3>🔐 Entrar / Cadastrar</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeAuth()">✕</button>
    </div>
    <div class="modal-body">
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0d8c8; padding-bottom: 10px;">
        <button id="tabLogin" style="flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; cursor: pointer; border-bottom: 3px solid var(--vermelho); color: var(--vermelho);" onclick="showAuthTab('login')">🔓 Entrar</button>
        <button id="tabRegister" style="flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: #aaa;" onclick="showAuthTab('register')">➕ Cadastrar</button>
      </div>
      <div id="authContent"></div>
    </div>
  </div>
</div>
    `;
    
    // Inserir modais no início do body
    document.body.insertAdjacentHTML('afterbegin', modalsHTML);
    console.log('✓ Modais recriados com sucesso');
    
    // Re-adicionar event listeners
    setupModalListeners();
  }
}

function setupModalListeners() {
  const cartOverlay = document.getElementById('cartOverlay');
  const checkoutModal = document.getElementById('checkoutModal');
  const authModal = document.getElementById('authModal');
  const cartBtn = document.querySelector('.cart-btn');
  const authBtn = document.querySelector('.auth-btn');
  
  if (cartBtn) {
    cartBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleCart();
    });
  }
  
  if (authBtn) {
    authBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openAuth();
    });
  }
  
  if (cartOverlay) {
    cartOverlay.addEventListener('click', (e) => {
      if (e.target === cartOverlay) toggleCart();
    });
  }
  
  if (checkoutModal) {
    checkoutModal.addEventListener('click', (e) => {
      if (e.target === checkoutModal) closeCheckout();
    });
  }
  
  if (authModal) {
    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) closeAuth();
    });
  }
}

async function getProducts() {
  try {
    console.log('🔄 Buscando produtos de:', API_URL);
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(`${API_URL}/products`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      signal: controller.signal
    });
    
    clearTimeout(timeout);
    console.log('✓ Resposta da API:', response.status);
    if (response.ok) {
      const products = await response.json();
      console.log('✓ Produtos carregados:', products.length);
      return products.map(p => ({ ...p, price: parseFloat(p.price) || 0 }));
    } else {
      console.error('✗ Erro na resposta da API:', response.status, response.statusText);
    }
  } catch (e) {
    console.error('✗ Erro ao buscar produtos:', e.message);
    if (e.name === 'AbortError') {
      console.error('✗ Requisição expirou (timeout)');
      showToast('Servidor demorando. Tentando novamente...');
    } else {
      showToast('Erro ao conectar com o servidor');
    }
  }
  console.warn('⚠️ Usando produto de demonstração');
  return [{ id: 1, name: 'Produto Demo', category: 'Demo', price: 19.90, stock: 10, active: true, image: null, description: 'Produto de demonstração' }];
}

async function renderProducts() {
  console.log('📦 renderProducts iniciado');
  const products = await getProducts();
  let filtered = products.filter(p =>
    p.active &&
    (currentFilter === 'all' || p.category === currentFilter)
  );

  if (currentSearch) {
    filtered = filtered.filter(p =>
      p.name.toLowerCase().includes(currentSearch) ||
      p.description.toLowerCase().includes(currentSearch)
    );
  }

  const container = safeGetElement('productsGrid');
  if (!container) {
    console.error('Elemento productsGrid não encontrado');
    return;
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="no-products"><span class="icon">🌶️</span><p>Nenhum produto disponível</p></div>';
    return;
  }

  container.innerHTML = filtered.map(p => `
    <div class="product-card">
      <div class="product-img">
        ${p.image ? `<img src="${p.image}" alt="${p.name}">` : '🌶️'}
      </div>
      <div class="product-body">
        <div class="product-category">${p.category}</div>
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.description}</div>
        <div class="product-footer">
          <div class="product-price">${fmt(p.price)}</div>
          <button class="add-cart-btn" onclick="addToCart(${p.id})" ${p.stock <= 0 ? 'disabled' : ''}>
            ${p.stock > 0 ? '🛒 Adicionar' : '❌ Indisponível'}
          </button>
        </div>
      </div>
    </div>
  `).join('');
  
  console.log('✓ renderProducts completado');
  ensureModalsExist(); // Verificar se modais ainda existem após renderizar
}

function filterProducts(category, button) {
  currentFilter = category;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  if (button) button.classList.add('active');
  renderProducts();
}

function handleSearch(query) {
  currentSearch = query.toLowerCase();
  renderProducts();
}

function toggleCart() {
  ensureModalsExist(); // Verificar se os modais existem
  console.log('🛒 toggleCart chamado');
  const sidebar = safeGetElement('cartSidebar');
  const overlay = safeGetElement('cartOverlay');
  console.log('✓ cartSidebar encontrado:', !!sidebar, 'cartOverlay encontrado:', !!overlay);
  
  if (sidebar) {
    sidebar.classList.toggle('open');
    console.log('✓ Toggle "open" aplicado ao cartSidebar');
    
    // Forçar estilos via JavaScript
    if (sidebar.classList.contains('open')) {
      sidebar.style.transform = 'translateX(0)';
      sidebar.style.display = 'flex';
      sidebar.style.zIndex = '201';
      console.log('✓ Estilos forçados: transform=translateX(0), display=flex, z-index=201');
    } else {
      sidebar.style.transform = 'translateX(500px)';
      console.log('✓ Estilos forçados: transform=translateX(500px) (fechar)');
    }
  } else {
    console.error('✗ Elemento cartSidebar não encontrado');
  }
  
  if (overlay) {
    overlay.classList.toggle('open');
    if (overlay.classList.contains('open')) {
      overlay.style.display = 'flex';
      overlay.style.zIndex = '200';
      console.log('✓ Overlay visível');
    } else {
      overlay.style.display = 'none';
      console.log('✓ Overlay oculto');
    }
  }
  
  renderCart();
}

function updateCartBadge() {
  const badge = safeGetElement('cartBadge');
  if (badge) badge.textContent = cart.reduce((s, i) => s + i.qty, 0);
}

function getCartTotal() {
  return cart.reduce((s, i) => s + i.price * i.qty, 0);
}

function fmt(v) {
  return 'R$ ' + Number(v).toFixed(2).replace('.', ',');
}

async function addToCart(id) {
  const products = await getProducts();
  const product = products.find(p => p.id === id);
  if (!product || product.stock <= 0) return;

  const existing = cart.find(i => i.id === id);
  if (existing) {
    if (existing.qty >= product.stock) {
      showToast('Quantidade máxima em estoque');
      return;
    }
    existing.qty++;
  } else {
    cart.push({
      id: product.id,
      name: product.name,
      price: product.price,
      qty: 1,
      image: product.image
    });
  }

  updateCartBadge();
  renderCart();
  showToast('Produto adicionado!');
}

function changeQty(id, delta) {
  const item = cart.find(i => i.id === id);
  if (!item) return;
  item.qty = Math.max(1, item.qty + delta);
  updateCartBadge();
  renderCart();
}

function removeFromCart(id) {
  cart = cart.filter(i => i.id !== id);
  updateCartBadge();
  renderCart();
}

function renderCart() {
  const container = safeGetElement('cartItems');
  const totalEl = safeGetElement('cartTotal');
  
  if (!container || !totalEl) return;
  totalEl.textContent = fmt(getCartTotal());

  if (cart.length === 0) {
    container.innerHTML = '<div class="empty-cart"><span class="icon">🛒</span><p>Seu carrinho está vazio</p></div>';
    return;
  }

  container.innerHTML = cart.map(item => `
    <div class="cart-item">
      <div class="cart-item-img">
        ${item.image ? `<img src="${item.image}">` : '🌶️'}
      </div>
      <div class="cart-item-info">
        <div class="cart-item-name">${item.name}</div>
        <div class="cart-item-price">${fmt(item.price * item.qty)}</div>
        <div class="qty-controls">
          <button class="qty-btn" onclick="changeQty(${item.id},-1)">−</button>
          <span class="qty-val">${item.qty}</span>
          <button class="qty-btn" onclick="changeQty(${item.id},1)">+</button>
          <button class="remove-btn" onclick="removeFromCart(${item.id})">🗑️</button>
        </div>
      </div>
    </div>
  `).join('');
}

function openCheckout() {
  ensureModalsExist();
  console.log('💳 openCheckout chamado, carrinho tem', cart.length, 'itens');
  if (cart.length === 0) {
    showToast('Adicione produtos ao carrinho!');
    return;
  }
  const checkoutBody = safeGetElement('checkoutBody');
  console.log('✓ checkoutBody encontrado:', !!checkoutBody);
  if (checkoutBody) {
    checkoutBody.innerHTML = `
      <h3>Resumo do Pedido</h3>
      <div style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 20px;">
        ${cart.map(item => `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>${item.name} (x${item.qty})</span><strong>${fmt(item.price * item.qty)}</strong></div>`).join('')}
        <div style="border-top: 2px solid #ddd; padding-top: 8px; margin-top: 8px; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between;"><span>Total:</span><span style="color: var(--vermelho);">${fmt(getCartTotal())}</span></div>
      </div>
      <div class="form-group">
        <label>Nome Completo</label>
        <input type="text" id="cName" placeholder="João Silva">
      </div>
      <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="cEmail" placeholder="joao@exemplo.com">
      </div>
      <button class="submit-order-btn" onclick="submitOrder()">✓ Confirmar Pedido</button>
    `;
  }
  const modal = safeGetElement('checkoutModal');
  if (modal) {
    modal.classList.add('open');
    modal.style.display = 'flex';
    modal.style.zIndex = '300';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    console.log('✓ checkoutModal aberto e estilos forçados');
  }
}

function closeCheckout() {
  const modal = safeGetElement('checkoutModal');
  if (modal) {
    modal.classList.remove('open');
    modal.style.display = 'none';
    console.log('✓ checkoutModal fechado');
  }
}

async function submitOrder() {
  const nameEl = safeGetElement('cName');
  const emailEl = safeGetElement('cEmail');
  const name = nameEl ? nameEl.value.trim() : '';
  const email = emailEl ? emailEl.value.trim() : '';

  if (!name || !email) {
    showToast('Preencha os campos obrigatórios!');
    return;
  }

  cart = [];
  updateCartBadge();
  const checkoutBody = safeGetElement('checkoutBody');
  if (checkoutBody) checkoutBody.innerHTML = '<div style="text-align:center;padding:40px"><span style="font-size:70px">🎉</span><h3 style="color:var(--vermelho);margin-top:20px">Pedido Confirmado!</h3><p>Obrigado pela compra!</p><button class="submit-order-btn" onclick="closeCheckout(); renderProducts();">Voltar às Compras</button></div>';
  showToast('Pedido realizado com sucesso!');
}

function openAuth() {
  ensureModalsExist();
  console.log('🔓 openAuth chamado');
  const authModal = safeGetElement('authModal');
  console.log('✓ authModal encontrado:', !!authModal);
  if (authModal) {
    authModal.classList.add('open');
    // Forçar estilos
    authModal.style.display = 'flex';
    authModal.style.zIndex = '300';
    authModal.style.alignItems = 'center';
    authModal.style.justifyContent = 'center';
    console.log('✓ Classe "open" adicionada ao authModal, estilos forçados');
    showAuthTab('login');
  } else {
    console.error('✗ Elemento authModal não foi encontrado no DOM');
  }
}

function closeAuth() {
  const authModal = safeGetElement('authModal');
  if (authModal) {
    authModal.classList.remove('open');
    authModal.style.display = 'none';
    console.log('✓ authModal fechado');
  }
}

function showAuthTab(tab) {
  console.log('📋 showAuthTab chamado com tab:', tab);
  const container = safeGetElement('authContent');
  const tabLogin = safeGetElement('tabLogin');
  const tabRegister = safeGetElement('tabRegister');
  
  console.log('✓ authContent:', !!container, 'tabLogin:', !!tabLogin, 'tabRegister:', !!tabRegister);
  if (!container || !tabLogin || !tabRegister) {
    console.error('✗ Um ou mais elementos de abas não foram encontrados');
    return;
  }

  if (tab === 'login') {
    tabLogin.style.color = 'var(--vermelho)';
    tabLogin.style.borderBottomColor = 'var(--vermelho)';
    tabRegister.style.color = '#aaa';
    tabRegister.style.borderBottomColor = 'transparent';
    
    container.innerHTML = `
      <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="aEmail" placeholder="seu@exemplo.com">
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="aPassword" placeholder="••••••••">
      </div>
      <button class="submit-order-btn" onclick="doLogin()">🔓 Entrar</button>
    `;
  } else {
    tabLogin.style.color = '#aaa';
    tabLogin.style.borderBottomColor = 'transparent';
    tabRegister.style.color = 'var(--vermelho)';
    tabRegister.style.borderBottomColor = 'var(--amarelo)';
    
    container.innerHTML = `
      <div class="form-group">
        <label>Nome Completo</label>
        <input type="text" id="rName" placeholder="Seu nome completo">
      </div>
      <div class="form-group">
        <label>CPF <small style="color:#c0392b">(exatamente 11 dígitos)</small></label>
        <input type="text" id="rCPF" placeholder="00000000000" maxlength="14">
      </div>
      <div class="form-group">
        <label>Telefone <small style="color:#c0392b">(81) 9 + 8 dígitos)</small></label>
        <input type="tel" id="rPhone" placeholder="(81) 9XXXX-XXXX" maxlength="15">
      </div>
      <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="rEmail" placeholder="seu@exemplo.com">
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="rPassword" placeholder="••••••••">
      </div>
      <button class="submit-order-btn" onclick="doRegister()">✅ Cadastrar</button>
    `;
    
    // Adicionar event listeners após renderizar os inputs
    setTimeout(() => {
      const phoneInput = document.getElementById('rPhone');
      const cpfInput = document.getElementById('rCPF');
      
      if (phoneInput) {
        // Inicializar com (81) 9
        phoneInput.value = '(81) 9';
        phoneInput.addEventListener('input', formatarTelefone);
        phoneInput.addEventListener('keydown', protegerPrefixoTelefone);
      }
      
      if (cpfInput) {
        cpfInput.addEventListener('input', formatarCPF);
      }
    }, 0);
  }
}

function doLogin() {
  showToast('Login realizado!');
  closeAuth();
}

function protegerPrefixoTelefone(e) {
  const input = e.target;
  // Se tentar apagar dentro dos primeiros 6 caracteres: (81) 9
  // Posições críticas: ( [ ]  8 [ ]  1 [ ]  ) [ ]  9
  // Apenas apagar é permitido nas posições após o 9
  if (e.key === 'Backspace' || e.key === 'Delete') {
    const cursorPos = input.selectionStart;
    // Impedir apagar antes da posição 6 (após o "9" de "(81) 9")
    if (cursorPos <= 6) {
      e.preventDefault();
      return false;
    }
  }
}

function formatarTelefone(e) {
  let valor = e.target.value.replace(/\D/g, '');
  
  // Forçar o prefixo (81)9 no início
  if (!valor.startsWith('819')) {
    if (valor.length === 0) {
      valor = '819';
    } else if (valor.length === 1) {
      valor = '819' + valor.substring(0, 0);
    } else if (valor.length === 2) {
      valor = '819' + valor.substring(0, 0);
    } else if (valor.length >= 3) {
      // Se o usuário digitou errado, corrigir para 819
      const resto = valor.substring(3);
      valor = '819' + resto.substring(0, 8);
    }
  }
  
  // Limitar a 11 dígitos (81 9 + 8 dígitos)
  valor = valor.substring(0, 11);
  
  // Formatar como (81) 9XXXX-XXXX
  let formatado = '';
  if (valor.length > 0) {
    formatado = '(' + valor.substring(0, 2);
    if (valor.length > 2) {
      formatado += ') ' + valor.substring(2, 7);
      if (valor.length > 7) {
        formatado += '-' + valor.substring(7);
      }
    } else {
      formatado += ')';
    }
  }
  
  e.target.value = formatado;
}

function formatarCPF(e) {
  let valor = e.target.value.replace(/\D/g, '');
  
  // Limitar a 11 dígitos
  valor = valor.substring(0, 11);
  
  // Formatar como XXX.XXX.XXX-XX
  let formatado = '';
  if (valor.length > 0) {
    formatado = valor.substring(0, 3);
    if (valor.length > 3) {
      formatado += '.' + valor.substring(3, 6);
      if (valor.length > 6) {
        formatado += '.' + valor.substring(6, 9);
        if (valor.length > 9) {
          formatado += '-' + valor.substring(9);
        }
      }
    }
  }
  
  e.target.value = formatado;
}

function validarTelefone(telefone) {
  // Remover formatação
  const apenas_numeros = telefone.replace(/\D/g, '');
  
  // Deve ter exatamente 11 dígitos
  if (apenas_numeros.length !== 11) {
    return false;
  }
  
  // Deve começar com 819
  if (!apenas_numeros.startsWith('819')) {
    return false;
  }
  
  return true;
}

function validarCPF(cpf) {
  // Remover formatação
  const apenas_numeros = cpf.replace(/\D/g, '');
  
  // Deve ter exatamente 11 dígitos
  if (apenas_numeros.length !== 11) {
    return false;
  }
  
  return true;
}

function doRegister() {
  const nameEl = document.getElementById('rName');
  const cpfEl = document.getElementById('rCPF');
  const phoneEl = document.getElementById('rPhone');
  const emailEl = document.getElementById('rEmail');
  const passwordEl = document.getElementById('rPassword');
  
  const name = nameEl ? nameEl.value.trim() : '';
  const cpf = cpfEl ? cpfEl.value.trim() : '';
  const phone = phoneEl ? phoneEl.value.trim() : '';
  const email = emailEl ? emailEl.value.trim() : '';
  const password = passwordEl ? passwordEl.value.trim() : '';
  
  // Validar campos obrigatórios
  if (!name) {
    showToast('⚠️ Preencha o nome completo!');
    return;
  }
  
  if (!cpf) {
    showToast('⚠️ Preencha o CPF!');
    return;
  }
  
  if (!validarCPF(cpf)) {
    showToast('⚠️ CPF deve conter exatamente 11 dígitos!');
    return;
  }
  
  if (!phone) {
    showToast('⚠️ Preencha o telefone!');
    return;
  }
  
  if (!validarTelefone(phone)) {
    showToast('⚠️ Telefone deve ser (81) 9 + 8 dígitos!');
    return;
  }
  
  if (!email) {
    showToast('⚠️ Preencha o e-mail!');
    return;
  }
  
  if (!password) {
    showToast('⚠️ Preencha a senha!');
    return;
  }
  
  // Enviar dados para a API
  const cpfNumeros = cpf.replace(/\D/g, '');
  const phoneNumeros = phone.replace(/\D/g, '');
  
  fetch(`${API_URL}/auth/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      cpf: cpfNumeros,
      phone: phoneNumeros,
      email,
      password
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      showToast('❌ ' + data.error);
    } else {
      showToast('✅ Cadastro realizado com sucesso!');
      // Armazenar token se necessário
      if (data.token) {
        localStorage.setItem('authToken', data.token);
      }
      closeAuth();
    }
  })
  .catch(err => {
    console.error('Erro no cadastro:', err);
    showToast('❌ Erro ao realizar cadastro');
  });
}

function showToast(msg) {
  const t = safeGetElement('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

document.addEventListener('DOMContentLoaded', () => {
  console.log('✓ DOM carregado - inicializando aplicação');
  console.log('✓ API URL:', API_URL);
  // Verificar se elementos críticos existem
  const criticalElements = ['authModal', 'cartSidebar', 'checkoutModal', 'productsGrid'];
  criticalElements.forEach(id => {
    const el = document.getElementById(id);
    console.log(`  ${el ? '✓' : '✗'} ${id}: ${el ? 'encontrado' : 'NÃO ENCONTRADO'}`);
  });
  
  // Monitorar mudanças no DOM
  const observer = new MutationObserver((mutations) => {
    // Verificar se algum elemento crítico foi removido
    const cartSidebar = document.getElementById('cartSidebar');
    const authModal = document.getElementById('authModal');
    const checkoutModal = document.getElementById('checkoutModal');
    
    if (!cartSidebar || !authModal || !checkoutModal) {
      console.error('❌ ALERTA: Um ou mais modais foram removidos do DOM!');
      ensureModalsExist();
    }
  });
  
  // Observar mudanças na body
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: false
  });
  
  // WATCHDOG: Verificar a cada 2 segundos se os modais existem
  setInterval(() => {
    ensureModalsExist();
  }, 2000);
  
  // Adicionar event listeners
  setupModalListeners();
  
  renderProducts();
});
</script>
</body>
</html>
