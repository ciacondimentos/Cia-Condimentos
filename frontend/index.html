<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cia de Condimentos e Especiarias</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --amarelo: #F5C518;
    --amarelo-escuro: #D4A017;
    --vermelho: #C0392B;
    --vermelho-escuro: #922B21;
    --creme: #FFF8E7;
    --marrom: #3E2723;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', sans-serif; background: var(--creme); color: var(--marrom); }

  header { background: var(--vermelho); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .header-top { background: var(--amarelo); text-align: center; padding: 6px; font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--vermelho-escuro); }
  .header-main { display: flex; align-items: center; justify-content: space-between; padding: 16px 40px; }
  .logo-wrap { display: flex; align-items: center; gap: 12px; }
  .logo-icon { height: 50px; width: auto; object-fit: contain; border-radius: 8px; }
  .logo-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--amarelo); line-height: 1.1; }
  .logo-sub { font-size: 10px; color: rgba(255,255,255,0.6); letter-spacing: 4px; text-transform: uppercase; }
  nav a { color: #fff; text-decoration: none; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 6px 12px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  nav a:hover { border-color: var(--amarelo); color: var(--amarelo); }
  .cart-btn { position: relative; background: var(--amarelo); color: var(--vermelho); border: none; padding: 10px 24px; font-weight: 700; font-size: 14px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; letter-spacing: 1px; }
  .cart-btn:hover { background: var(--amarelo-escuro); }
  .cart-badge { position: absolute; top: -8px; right: -8px; background: var(--vermelho); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 900; }

  .hero { background: linear-gradient(135deg, var(--vermelho) 0%, var(--vermelho-escuro) 50%, #1a0a00 100%); padding: 80px 40px; text-align: center; position: relative; overflow: hidden; }
  .hero::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23F5C518' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E") repeat; }
  .hero-content { position: relative; z-index: 1; }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: 56px; color: var(--amarelo); font-weight: 900; line-height: 1.1; text-shadow: 2px 4px 20px rgba(0,0,0,0.4); }
  .hero p { color: rgba(255,255,255,0.85); font-size: 18px; margin-top: 16px; font-weight: 300; letter-spacing: 1px; }
  .hero-btn { display: inline-block; margin-top: 32px; background: var(--amarelo); color: var(--vermelho); padding: 16px 48px; font-weight: 900; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; border-radius: 4px; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .hero-btn:hover { background: var(--amarelo-escuro); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

  .filter-bar { background: var(--marrom); padding: 16px 40px; display: flex; align-items: center; gap: 12px; overflow-x: auto; }
  .filter-label { color: var(--amarelo); font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; white-space: nowrap; }
  .filter-btn { background: transparent; border: 1px solid rgba(245,197,24,0.3); color: rgba(255,255,255,0.7); padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
  .filter-btn:hover, .filter-btn.active { background: var(--amarelo); color: var(--marrom); border-color: var(--amarelo); font-weight: 700; }
  .search-input { flex: 1; max-width: 300px; padding: 8px 16px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 14px; outline: none; margin-left: auto; }
  .search-input::placeholder { color: rgba(255,255,255,0.4); }

  .section-title { text-align: center; padding: 60px 40px 40px; }
  .section-title h2 { font-family: 'Playfair Display', serif; font-size: 36px; color: var(--vermelho); font-weight: 700; }
  .section-title .line { width: 60px; height: 4px; background: var(--amarelo); margin: 12px auto 0; border-radius: 2px; }

  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 28px; padding: 0 40px 60px; max-width: 1400px; margin: 0 auto; }

  .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: all 0.3s; position: relative; }
  .product-card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,0,0,0.16); }
  .product-img { width: 100%; height: 220px; background: #f0e8d0; display: flex; align-items: center; justify-content: center; font-size: 60px; overflow: hidden; }
  .product-img img { width: 100%; height: 100%; object-fit: cover; }
  .product-body { padding: 20px; }
  .product-category { font-size: 11px; font-weight: 700; color: var(--amarelo-escuro); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
  .product-name { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--marrom); margin-bottom: 8px; line-height: 1.3; }
  .product-desc { font-size: 13px; color: #888; line-height: 1.5; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .product-stock { font-size: 12px; color: var(--vermelho); font-weight: 700; margin-bottom: 16px; }
  .product-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0e8d0; padding-top: 16px; }
  .product-price { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--vermelho); }
  .add-cart-btn { background: var(--vermelho); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
  .add-cart-btn:hover { background: var(--vermelho-escuro); transform: scale(1.05); }
  .add-cart-btn:disabled { background: #ccc; cursor: not-allowed; }

  .cart-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; }
  .cart-overlay.open { display: block; }
  .cart-sidebar { position: fixed; top: 0; right: 0; width: 440px; height: 100vh; background: white; z-index: 201; display: flex; flex-direction: column; transform: translateX(500px); transition: transform 0.3s ease-in-out; box-shadow: -8px 0 40px rgba(0,0,0,0.2); }
  .cart-sidebar.open { transform: translateX(0); }
  .cart-header { background: var(--vermelho); color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
  .cart-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .cart-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
  .cart-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f0e8d0; }
  .cart-item-img { width: 70px; height: 70px; background: #f0e8d0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
  .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-weight: 700; font-size: 15px; color: var(--marrom); }
  .cart-item-price { color: var(--vermelho); font-weight: 700; font-size: 16px; margin-top: 4px; }
  .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  .qty-btn { background: var(--amarelo); border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: 900; cursor: pointer; }
  .qty-val { font-weight: 700; font-size: 16px; min-width: 24px; text-align: center; }
  .remove-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
  .cart-footer { padding: 20px; border-top: 2px solid #f0e8d0; }
  .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; margin-bottom: 16px; }
  .cart-total span:last-child { color: var(--vermelho); }
  .checkout-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; }
  .empty-cart { text-align: center; padding: 60px 20px; color: #aaa; }
  .empty-cart .icon { font-size: 60px; margin-bottom: 16px; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; display: none; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 12px; max-width: 560px; width: 100%; overflow: hidden; }
  .modal-header { background: var(--vermelho); padding: 24px 28px; color: white; display: flex; justify-content: space-between; align-items: center; }
  .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .modal-body { padding: 28px; max-height: 80vh; overflow-y: auto; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; color: var(--marrom); margin-bottom: 6px; }
  .form-group input { width: 100%; padding: 10px 14px; border: 2px solid #e0d8c8; border-radius: 4px; font-size: 14px; }
  .form-group input:focus { border-color: var(--amarelo); outline: none; }
  .submit-order-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; margin-top: 16px; }
  .submit-order-btn:hover { background: var(--vermelho-escuro); }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--marrom); color: white; padding: 14px 28px; border-radius: 8px; font-weight: 700; z-index: 500; transition: transform 0.3s; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  footer { background: var(--marrom); color: rgba(255,255,255,0.6); text-align: center; padding: 32px; font-size: 13px; }
  footer .brand { font-family: 'Playfair Display', serif; color: var(--amarelo); font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .no-products { text-align: center; padding: 80px 20px; color: #aaa; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="cart-overlay" id="cartOverlay"></div>
<div class="cart-sidebar" id="cartSidebar">
  <div class="cart-header">
    <h3>🛒 Seu Carrinho</h3>
    <button class="cart-close" onclick="closeCart()">✕</button>
  </div>
  <div class="cart-items" id="cartItems"></div>
  <div class="cart-footer">
    <div class="cart-total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
    <button class="checkout-btn" onclick="openCheckout()">Finalizar Compra</button>
  </div>
</div>

<div class="modal-overlay" id="checkoutModal">
  <div class="modal" onclick="event.stopPropagation();">
    <div class="modal-header">
      <h3>🌶️ Finalizar Pedido</h3>
      <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer" onclick="closeCheckout()">✕</button>
    </div>
    <div class="modal-body" id="checkoutBody"></div>
  </div>
</div>

<header>
  <div class="header-top">✦ FRETE GRÁTIS A PARTIR DE R$ 50 ✦</div>
  <div class="header-main">
    <div class="logo-wrap">
      <img src="img/logotipooficialciadecondimentos.png" alt="Cia de Condimentos" class="logo-icon" />
      <div>
        <div class="logo-title">Cia de Condimentos</div>
        <div class="logo-sub">Especiarias Premium</div>
      </div>
    </div>
    <nav>
      <a href="#inicio">Início</a>
      <a href="#produtos">Produtos</a>
      <a href="#contato">Contato</a>
    </nav>
    <div style="display:flex;align-items:center;">
      <button class="cart-btn" onclick="openCart()">🛒 Carrinho <span class="cart-badge" id="cartBadge">0</span></button>
    </div>
  </div>
</header>

<section class="hero" id="inicio">
  <div class="hero-content">
    <h1>Sabores do Mundo</h1>
    <p>Experimente os melhores condimentos e especiarias selecionados com excelência</p>
    <button class="hero-btn" onclick="document.getElementById('produtos').scrollIntoView({ behavior: 'smooth' })">Comprar Agora</button>
  </div>
</section>

<section class="filter-bar" id="produtos">
  <span class="filter-label">Filtrar:</span>
  <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
  <button class="filter-btn" onclick="filterProducts('Pimentas', this)">Pimentas</button>
  <button class="filter-btn" onclick="filterProducts('Especiarias', this)">Especiarias</button>
  <button class="filter-btn" onclick="filterProducts('Ervas', this)">Ervas</button>
  <input type="text" class="search-input" id="searchInput" placeholder="Buscar produtos..." onkeyup="handleSearch(this.value)">
</section>

<section class="section-title">
  <h2>Nossos Produtos</h2>
  <div class="line"></div>
</section>

<div class="products-grid" id="productsGrid"></div>

<footer>
  <div class="brand">Cia de Condimentos</div>
  <p>© 2026 Todos os direitos reservados</p>
</footer>

<script>
const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
  ? 'http://localhost:3000/api'
  : 'https://cia-condimentos.onrender.com/api';

let cart = [];
let currentFilter = 'all';
let currentSearch = '';

/* ── Inicialização ── */
document.addEventListener('DOMContentLoaded', () => {
  var overlay = document.getElementById('cartOverlay');
  if (overlay) overlay.addEventListener('click', closeCart);

  var checkoutModal = document.getElementById('checkoutModal');
  if (checkoutModal) checkoutModal.addEventListener('click', function(e) {
    if (e.target === this) closeCheckout();
  });

  renderProducts();
});

/* ── Carrinho ── */
function getCartElements() {
  var sidebar = document.getElementById('cartSidebar');
  var overlay = document.getElementById('cartOverlay');
  // Se a extensão do navegador removeu os elementos, recria
  if (!sidebar) {
    sidebar = document.createElement('div');
    sidebar.id = 'cartSidebar';
    sidebar.className = 'cart-sidebar';
    sidebar.innerHTML = '<div class="cart-header"><h3>🛒 Seu Carrinho</h3><button class="cart-close" onclick="closeCart()">✕</button></div><div class="cart-items" id="cartItems"></div><div class="cart-footer"><div class="cart-total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div><button class="checkout-btn" onclick="openCheckout()">Finalizar Compra</button></div>';
    document.body.insertBefore(sidebar, document.body.firstChild);
  }
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'cartOverlay';
    overlay.className = 'cart-overlay';
    overlay.addEventListener('click', closeCart);
    document.body.insertBefore(overlay, document.body.firstChild);
  }
  return { sidebar: sidebar, overlay: overlay };
}

function toggleCart() {
  var els = getCartElements();
  els.sidebar.classList.toggle('open');
  els.overlay.classList.toggle('open');
  // Re-renderiza itens ao abrir
  if (els.sidebar.classList.contains('open')) renderCartItems();
}

function openCart() {
  var els = getCartElements();
  els.sidebar.classList.add('open');
  els.overlay.classList.add('open');
  renderCartItems();
}

function closeCart() {
  var els = getCartElements();
  els.sidebar.classList.remove('open');
  els.overlay.classList.remove('open');
}

function addToCart(productId) {
  const existing = cart.find(i => i.id === productId);
  existing ? existing.qty++ : cart.push({ id: productId, qty: 1 });
  updateCartBadge();
  renderCartItems();
  showToast('✅ Produto adicionado ao carrinho!');
}

function updateCartBadge() {
  const badge = document.getElementById('cartBadge');
  if (badge) badge.textContent = cart.reduce((s, i) => s + i.qty, 0);
}

function changeQty(productId, delta) {
  const item = cart.find(i => i.id === productId);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(i => i.id !== productId);
  updateCartBadge();
  renderCartItems();
}

function removeFromCart(productId) {
  cart = cart.filter(i => i.id !== productId);
  updateCartBadge();
  renderCartItems();
}

function renderCartItems() {
  const container = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  if (!container) return;

  if (cart.length === 0) {
    container.innerHTML = '<div class="empty-cart"><div class="icon">🛒</div><p>Seu carrinho está vazio</p></div>';
    if (totalEl) totalEl.textContent = 'R$ 0,00';
    return;
  }

  getProducts().then(products => {
    let total = 0;
    container.innerHTML = cart.map(item => {
      const p = products.find(x => x.id === item.id);
      if (!p) return '';
      const subtotal = p.price * item.qty;
      total += subtotal;
      const imgHtml = p.image
        ? `<img src="${p.image}" alt="${p.name}" onerror="this.parentElement.innerHTML='🌶️'">`
        : '🌶️';
      return `
        <div class="cart-item">
          <div class="cart-item-img">${imgHtml}</div>
          <div class="cart-item-info">
            <div class="cart-item-name">${p.name}</div>
            <div class="cart-item-price">R$ ${subtotal.toFixed(2).replace('.', ',')}</div>
            <div class="qty-controls">
              <button class="qty-btn" onclick="changeQty(${p.id}, -1)">−</button>
              <span class="qty-val">${item.qty}</span>
              <button class="qty-btn" onclick="changeQty(${p.id}, 1)">+</button>
              <button class="remove-btn" onclick="removeFromCart(${p.id})">🗑</button>
            </div>
          </div>
        </div>`;
    }).join('');
    if (totalEl) totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
  });
}

/* ── Checkout ── */
function openCheckout() {
  if (cart.length === 0) { showToast('⚠️ Seu carrinho está vazio!'); return; }
  const modal = document.getElementById('checkoutModal');
  const body  = document.getElementById('checkoutBody');
  if (!modal || !body) return;

  getProducts().then(products => {
    let total = 0;
    const itemsHtml = cart.map(item => {
      const p = products.find(x => x.id === item.id);
      if (!p) return '';
      const subtotal = p.price * item.qty;
      total += subtotal;
      return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0e8d0;">
        <span>${p.name} x${item.qty}</span>
        <span>R$ ${subtotal.toFixed(2).replace('.', ',')}</span>
      </div>`;
    }).join('');

    body.innerHTML = `
      <div style="margin-bottom:20px;">${itemsHtml}</div>
      <div style="font-size:20px;font-weight:900;display:flex;justify-content:space-between;margin-bottom:20px;">
        <span>Total</span><span style="color:var(--vermelho)">R$ ${total.toFixed(2).replace('.', ',')}</span>
      </div>
      <div class="form-group"><label>Nome Completo *</label><input type="text" id="checkoutName" placeholder="Seu nome"></div>
      <div class="form-group"><label>Telefone *</label><input type="text" id="checkoutPhone" placeholder="(81) 9 XXXX-XXXX" oninput="maskPhone(this)"></div>
      <div class="form-group"><label>Endereço de Entrega *</label><input type="text" id="checkoutAddress" placeholder="Rua, número, bairro, cidade"></div>
      <div class="form-group"><label>Observações</label><input type="text" id="checkoutObs" placeholder="Instruções especiais..."></div>
      <button id="submitOrderBtn" class="submit-order-btn">✅ Confirmar Pedido via WhatsApp</button>
    `;

    // Fecha o carrinho e abre o modal
    document.getElementById('cartSidebar').classList.remove('open');
    document.getElementById('cartOverlay').classList.remove('open');
    modal.classList.add('open');

    // Attach debug handler to the submit button (replaces previous handler to avoid duplicates)
    const submitBtn = document.getElementById('submitOrderBtn');
    if (submitBtn) {
      submitBtn.onclick = function (e) {
        try {
          console.log('DEBUG: submitOrderBtn clicked', {
            cartLength: Array.isArray(cart) ? cart.length : 0,
            cart: JSON.parse(JSON.stringify(cart || [])),
            formValues: {
              name: document.getElementById('checkoutName')?.value,
              phone: document.getElementById('checkoutPhone')?.value,
              address: document.getElementById('checkoutAddress')?.value
            }
          });
        } catch (err) {
          console.log('DEBUG: error serializing cart for log', err);
        }
        // chamar a função principal de envio
        submitOrder();
      };
    }
  });
}

function closeCheckout() {
  document.getElementById('checkoutModal').classList.remove('open');
}

async function submitOrder() {
  const name    = document.getElementById('checkoutName')?.value?.trim();
  const phone   = document.getElementById('checkoutPhone')?.value?.trim();
  const address = document.getElementById('checkoutAddress')?.value?.trim();
  const obs     = document.getElementById('checkoutObs')?.value?.trim();

  if (!name || !phone || !address) { 
    showToast('⚠️ Preencha todos os campos obrigatórios!'); 
    return; 
  }

  try {
    const products = await getProducts();
    let total = 0;
    const orderItems = cart.map(item => {
      const p = products.find(x => x.id === item.id);
      if (!p) return null;
      const subtotal = p.price * item.qty;
      total += subtotal;
      return {
        id: item.id,
        qty: item.qty,
        price: p.price,
        name: p.name
      };
    }).filter(Boolean);

    if (orderItems.length === 0) {
      showToast('❌ Erro: Nenhum produto válido no carrinho');
      return;
    }

    // Salvar pedido no backend
    const orderData = {
      customer: {
        name: name,
        email: '', // Opcional por enquanto
        phone: phone,
        cpf: '', // Opcional por enquanto
        address: address
      },
      items: orderItems,
      subtotal: total,
      frete: 0, // Frete grátis ou calcular
      total: total,
      payment: 'WhatsApp',
      status: 'Pendente',
      paymentStatus: 'Aguardando'
    };

    const response = await fetch(`${API_URL}/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Erro ao salvar pedido');
    }

    const orderResult = await response.json();

    // Gerar mensagem do WhatsApp
    const lines = orderItems.map(item => 
      `• ${item.name} x${item.qty} = R$ ${(item.price * item.qty).toFixed(2).replace('.', ',')}`
    ).join('\n');

    const msg = `🌶️ *NOVO PEDIDO - Cia de Condimentos*\n\n👤 *Cliente:* ${name}\n📱 *Telefone:* ${phone}\n📍 *Endereço:* ${address}\n${obs ? `📝 *Obs:* ${obs}\n` : ''}\n*Itens:*\n${lines}\n\n💰 *Total: R$ ${total.toFixed(2).replace('.', ',')}*\n\n*Pedido #${orderResult.id}*`;

    // Abrir WhatsApp
    window.open(`https://wa.me/5581999999999?text=${encodeURIComponent(msg)}`, '_blank');
    
    // Limpar carrinho e fechar modal
    cart = [];
    updateCartBadge();
    closeCheckout();
    showToast('✅ Pedido enviado via WhatsApp!');

  } catch (error) {
    console.error('Error submitting order:', error);
    showToast(`❌ Erro ao enviar pedido: ${error.message}`);
  }
}

/* ── Produtos ── */
async function getProducts() {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    const response = await fetch(`${API_URL}/products`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (response.ok) {
      const products = await response.json();
      return products.map(p => ({ ...p, price: parseFloat(p.price) || 0 }));
    }
  } catch (e) {
    if (e.name === 'AbortError') {
      showToast('Servidor demorando. Tentando novamente...');
    } else {
      showToast('Erro ao conectar com o servidor');
    }
  }
  return [{ id: 1, name: 'Produto Demo', category: 'Demo', price: 19.90, stock: 10, active: true, image: null, description: 'Produto de demonstração' }];
}

async function renderProducts() {
  const products = await getProducts();
  let filtered = products.filter(p =>
    p.active && (currentFilter === 'all' || p.category === currentFilter)
  );
  if (currentSearch) {
    filtered = filtered.filter(p =>
      p.name.toLowerCase().includes(currentSearch) ||
      (p.description || '').toLowerCase().includes(currentSearch)
    );
  }

  const grid = document.getElementById('productsGrid');
  if (!grid) return;

  if (filtered.length === 0) {
    grid.innerHTML = '<div class="no-products">Nenhum produto encontrado.</div>';
    return;
  }

  grid.innerHTML = filtered.map(p => {
    const imgHtml = p.image
      ? `<img src="${p.image}" alt="${p.name}" onerror="this.parentElement.innerHTML='🌶️'">`
      : '🌶️';
    return `
      <div class="product-card">
        <div class="product-img">${imgHtml}</div>
        <div class="product-body">
          <div class="product-category">${p.category || ''}</div>
          <div class="product-name">${p.name}</div>
          <div class="product-desc">${p.description || ''}</div>
          <div class="product-stock">Estoque: ${p.stock} unidades</div>
          <div class="product-footer">
            <div class="product-price">R$ ${p.price.toFixed(2).replace('.', ',')}</div>
            <button class="add-cart-btn" onclick="addToCart(${p.id})" ${p.stock === 0 ? 'disabled' : ''}>
              ${p.stock === 0 ? 'Esgotado' : 'Adicionar'}
            </button>
          </div>
        </div>
      </div>`;
  }).join('');
}

function filterProducts(category, btn) {
  currentFilter = category;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderProducts();
}

function handleSearch(val) {
  currentSearch = val.toLowerCase();
  renderProducts();
}

/* ── Máscara ── */
function maskPhone(input) {
  let v = input.value.replace(/\D/g, '').slice(0, 11);
  if (v.length <= 2) input.value = v.length ? `(${v}` : v;
  else if (v.length <= 7) input.value = `(${v.slice(0,2)}) ${v.slice(2)}`;
  else input.value = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
}

/* ── Toast ── */
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>