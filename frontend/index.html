<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cia de Condimentos e Especiarias</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --amarelo: #F5C518;
    --amarelo-escuro: #D4A017;
    --vermelho: #C0392B;
    --vermelho-escuro: #922B21;
    --creme: #FFF8E7;
    --marrom: #3E2723;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', sans-serif; background: var(--creme); color: var(--marrom); }

  header { background: var(--vermelho); position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .header-top { background: var(--amarelo); text-align: center; padding: 6px; font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--vermelho-escuro); }
  .header-main { display: flex; align-items: center; justify-content: space-between; padding: 16px 40px; }
  .logo-wrap { display: flex; align-items: center; gap: 12px; }
  .logo-icon { height: 50px; width: auto; object-fit: contain; border-radius: 8px; }
  .logo-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--amarelo); line-height: 1.1; }
  .logo-sub { font-size: 10px; color: rgba(255,255,255,0.6); letter-spacing: 4px; text-transform: uppercase; }
  nav a { color: #fff; text-decoration: none; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 6px 12px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  nav a:hover { border-color: var(--amarelo); color: var(--amarelo); }
  .cart-btn { position: relative; background: var(--amarelo); color: var(--vermelho); border: none; padding: 10px 24px; font-weight: 700; font-size: 14px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; letter-spacing: 1px; }
  .cart-btn:hover { background: var(--amarelo-escuro); }
  .cart-badge { position: absolute; top: -8px; right: -8px; background: var(--vermelho); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 900; }

  .hero { background: linear-gradient(135deg, var(--vermelho) 0%, var(--vermelho-escuro) 50%, #1a0a00 100%); padding: 80px 40px; text-align: center; position: relative; overflow: hidden; }
  .hero::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23F5C518' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E") repeat; }
  .hero-content { position: relative; z-index: 1; }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: 56px; color: var(--amarelo); font-weight: 900; line-height: 1.1; text-shadow: 2px 4px 20px rgba(0,0,0,0.4); }
  .hero p { color: rgba(255,255,255,0.85); font-size: 18px; margin-top: 16px; font-weight: 300; letter-spacing: 1px; }
  .hero-btn { display: inline-block; margin-top: 32px; background: var(--amarelo); color: var(--vermelho); padding: 16px 48px; font-weight: 900; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; border-radius: 4px; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .hero-btn:hover { background: var(--amarelo-escuro); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

  .filter-bar { background: var(--marrom); padding: 16px 40px; display: flex; align-items: center; gap: 12px; overflow-x: auto; }
  .filter-label { color: var(--amarelo); font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; white-space: nowrap; }
  .filter-btn { background: transparent; border: 1px solid rgba(245,197,24,0.3); color: rgba(255,255,255,0.7); padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
  .filter-btn:hover, .filter-btn.active { background: var(--amarelo); color: var(--marrom); border-color: var(--amarelo); font-weight: 700; }
  .search-input { flex: 1; max-width: 300px; padding: 8px 16px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 14px; outline: none; margin-left: auto; }
  .search-input::placeholder { color: rgba(255,255,255,0.4); }

  .section-title { text-align: center; padding: 60px 40px 40px; }
  .section-title h2 { font-family: 'Playfair Display', serif; font-size: 36px; color: var(--vermelho); font-weight: 700; }
  .section-title .line { width: 60px; height: 4px; background: var(--amarelo); margin: 12px auto 0; border-radius: 2px; }

  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 28px; padding: 0 40px 60px; max-width: 1400px; margin: 0 auto; }

  .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: all 0.3s; position: relative; }
  .product-card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,0,0,0.16); }
  .product-img { width: 100%; height: 220px; background: #f0e8d0; display: flex; align-items: center; justify-content: center; font-size: 60px; overflow: hidden; }
  .product-img img { width: 100%; height: 100%; object-fit: cover; }
  .product-body { padding: 20px; }
  .product-category { font-size: 11px; font-weight: 700; color: var(--amarelo-escuro); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
  .product-name { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--marrom); margin-bottom: 8px; line-height: 1.3; }
  .product-desc { font-size: 13px; color: #888; line-height: 1.5; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .product-stock { font-size: 12px; color: var(--vermelho); font-weight: 700; margin-bottom: 16px; }
  .product-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0e8d0; padding-top: 16px; }
  .product-price { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; color: var(--vermelho); }
  .add-cart-btn { background: var(--vermelho); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
  .add-cart-btn:hover { background: var(--vermelho-escuro); transform: scale(1.05); }
  .add-cart-btn:disabled { background: #ccc; cursor: not-allowed; }

  /* Carrinho Sidebar — z-index 1000/1001, acima do header (50) */
  .cart-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; }
  .cart-overlay.open { display: block; }
  .cart-sidebar { position: fixed; top: 0; right: 0; width: 440px; height: 100vh; background: white; z-index: 1001; display: flex; flex-direction: column; transform: translateX(500px); transition: transform 0.3s ease-in-out; box-shadow: -8px 0 40px rgba(0,0,0,0.2); }
  .cart-sidebar.open { transform: translateX(0); }
  .cart-header { background: var(--vermelho); color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
  .cart-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .cart-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
  .cart-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f0e8d0; }
  .cart-item-img { width: 70px; height: 70px; background: #f0e8d0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
  .cart-item-img img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-weight: 700; font-size: 15px; color: var(--marrom); }
  .cart-item-price { color: var(--vermelho); font-weight: 700; font-size: 16px; margin-top: 4px; }
  .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  .qty-btn { background: var(--amarelo); border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: 900; cursor: pointer; font-size: 16px; line-height: 1; }
  .qty-val { font-weight: 700; font-size: 16px; min-width: 24px; text-align: center; }
  .remove-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
  .cart-footer { padding: 20px; border-top: 2px solid #f0e8d0; background: white; }
  .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; margin-bottom: 16px; }
  .cart-total span:last-child { color: var(--vermelho); }
  .checkout-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; font-size: 16px; letter-spacing: 1px; transition: background 0.2s; }
  .checkout-btn:hover { background: var(--vermelho-escuro); }
  .empty-cart { text-align: center; padding: 60px 20px; color: #aaa; }
  .empty-cart .icon { font-size: 60px; margin-bottom: 16px; }

  /* Modal de Checkout — z-index 1200, ACIMA do sidebar (1001) */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1200; display: none; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 12px; max-width: 560px; width: 100%; overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; }
  .modal-header { background: var(--vermelho); padding: 24px 28px; color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .modal-body { padding: 28px; overflow-y: auto; flex: 1; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; color: var(--marrom); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
  .form-group input { width: 100%; padding: 10px 14px; border: 2px solid #e0d8c8; border-radius: 4px; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
  .form-group input:focus { border-color: var(--amarelo); outline: none; }
  .order-summary { background: #fdf8ee; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
  .order-summary-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0e8d0; font-size: 14px; }
  .order-summary-item:last-child { border-bottom: none; }
  .order-total-row { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; padding: 16px 0 0; }
  .order-total-row span:last-child { color: var(--vermelho); }
  .submit-order-btn { width: 100%; background: var(--vermelho); color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; margin-top: 16px; font-size: 16px; letter-spacing: 1px; transition: background 0.2s; }
  .submit-order-btn:hover { background: var(--vermelho-escuro); }
  .submit-order-btn:disabled { background: #aaa; cursor: not-allowed; }

  /* Payment Method Selection */
  .payment-methods-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 24px; }
  .payment-method-card { border: 2px solid #e8e0d4; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: white; }
  .payment-method-card:hover { border-color: var(--vermelho); background: #fff9f5; transform: translateY(-2px); }
  .payment-method-card.selected { border-color: var(--vermelho); background: #ffe5e0; }
  .payment-method-icon { font-size: 48px; margin-bottom: 12px; }
  .payment-method-name { font-weight: 900; color: var(--marrom); font-size: 16px; }

  /* Payment Method Selection */
  .payment-methods-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 24px; }
  .payment-method-card { border: 2px solid #e8e0d4; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: white; }
  .payment-method-card:hover { border-color: var(--vermelho); background: #fff9f5; transform: translateY(-2px); }
  .payment-method-card.selected { border-color: var(--vermelho); background: #ffe5e0; }
  .payment-method-icon { font-size: 48px; margin-bottom: 12px; }
  .payment-method-name { font-weight: 900; color: var(--marrom); font-size: 16px; }

  /* Toast — z-index 1500, acima de tudo */
  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--marrom); color: white; padding: 14px 28px; border-radius: 8px; font-weight: 700; z-index: 1500; transition: transform 0.3s; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  footer { background: var(--marrom); color: rgba(255,255,255,0.6); text-align: center; padding: 32px; font-size: 13px; }
  footer .brand { font-family: 'Playfair Display', serif; color: var(--amarelo); font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .no-products { text-align: center; padding: 80px 20px; color: #aaa; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- Overlay e Sidebar do Carrinho -->
<div class="cart-overlay" id="cartOverlay"></div>
<div class="cart-sidebar" id="cartSidebar">
  <div class="cart-header">
    <h3>&#x1F6D2; Seu Carrinho</h3>
    <button class="cart-close" id="cartCloseBtn">&#x2715;</button>
  </div>
  <div class="cart-items" id="cartItems"></div>
  <div class="cart-footer">
    <div class="cart-total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
    <button class="checkout-btn" id="checkoutBtn">Finalizar Compra &#x2192;</button>
  </div>
</div>

<!-- Modal de Checkout — z-index 400, fica ACIMA do sidebar -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal" id="checkoutModalInner">
    <div class="modal-header">
      <h3>&#x1F336;&#xFE0F; Finalizar Pedido</h3>
      <button id="closeCheckoutBtn" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;line-height:1;">&#x2715;</button>
    </div>
    <div class="modal-body" id="checkoutBody"></div>
  </div>
</div>

<header>
  <div class="header-top">&#x2726; FRETE GR&#xC1;TIS A PARTIR DE R$ 50 &#x2726;</div>
  <div class="header-main">
    <div class="logo-wrap">
      <img src="img/logotipooficialciadecondimentos.png" alt="Cia de Condimentos" class="logo-icon" />
      <div>
        <div class="logo-title">Cia de Condimentos</div>
        <div class="logo-sub">Especiarias Premium</div>
      </div>
    </div>
    <nav>
      <a href="#inicio">In&#xED;cio</a>
      <a href="#produtos">Produtos</a>
      <a href="#contato">Contato</a>
    </nav>
    <div style="display:flex;align-items:center;">
      <button class="cart-btn" id="openCartBtn">&#x1F6D2; Carrinho <span class="cart-badge" id="cartBadge">0</span></button>
    </div>
  </div>
</header>

<section class="hero" id="inicio">
  <div class="hero-content">
    <h1>Sabores do Mundo</h1>
    <p>Experimente os melhores condimentos e especiarias selecionados com excel&#xEA;ncia</p>
    <button class="hero-btn" onclick="document.getElementById('produtos').scrollIntoView({ behavior: 'smooth' })">Comprar Agora</button>
  </div>
</section>

<section class="filter-bar" id="produtos">
  <span class="filter-label">Filtrar:</span>
  <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
  <button class="filter-btn" onclick="filterProducts('Pimentas', this)">Pimentas</button>
  <button class="filter-btn" onclick="filterProducts('Especiarias', this)">Especiarias</button>
  <button class="filter-btn" onclick="filterProducts('Ervas', this)">Ervas</button>
  <input type="text" class="search-input" id="searchInput" placeholder="Buscar produtos..." onkeyup="handleSearch(this.value)">
</section>

<section class="section-title">
  <h2>Nossos Produtos</h2>
  <div class="line"></div>
</section>

<div class="products-grid" id="productsGrid"></div>

<footer>
  <div class="brand">Cia de Condimentos</div>
  <p>&#xa9; 2026 Todos os direitos reservados</p>
</footer>

<script>
'use strict';

const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
  ? 'http://localhost:3000/api'
  : 'https://cia-condimentos.onrender.com/api';

let cart = [];
let currentFilter = 'all';
let currentSearch = '';

/* ════════════════════════════════════
   INICIALIZACAO — todos os listeners
   ════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', function() {

  function safeListener(id, event, fn) {
    var el = document.getElementById(id);
    if (el) { el.addEventListener(event, fn); }
    else { console.warn('Elemento nao encontrado: #' + id); }
  }

  // Abrir carrinho
  safeListener('openCartBtn', 'click', openCart);

  // Fechar carrinho
  safeListener('cartCloseBtn', 'click', closeCart);
  safeListener('cartOverlay',  'click', closeCart);

  // Botao Finalizar Compra
  safeListener('checkoutBtn', 'click', openCheckout);

  // Fechar modal de checkout
  safeListener('closeCheckoutBtn', 'click', closeCheckout);
  var checkoutModal = document.getElementById('checkoutModal');
  if (checkoutModal) {
    checkoutModal.addEventListener('click', function(e) {
      if (e.target === this) closeCheckout();
    });
  }

  renderProducts();
});

/* ════════════════════════════════════
   CARRINHO
   ════════════════════════════════════ */
function openCart() {
  var sidebar = document.getElementById('cartSidebar');
  var overlay = document.getElementById('cartOverlay');
  if (!sidebar || !overlay) { console.error('Elementos do carrinho nao encontrados'); return; }
  sidebar.classList.add('open');
  overlay.classList.add('open');
  renderCartItems();
}

function closeCart() {
  var sidebar = document.getElementById('cartSidebar');
  var overlay = document.getElementById('cartOverlay');
  if (sidebar) sidebar.classList.remove('open');
  if (overlay) overlay.classList.remove('open');
}

function addToCart(productId) {
  var existing = cart.find(function(i) { return i.id === productId; });
  if (existing) { existing.qty++; } else { cart.push({ id: productId, qty: 1 }); }
  updateCartBadge();
  renderCartItems();
  showToast('Produto adicionado ao carrinho!');
}

function updateCartBadge() {
  var badge = document.getElementById('cartBadge');
  if (badge) badge.textContent = cart.reduce(function(s, i) { return s + i.qty; }, 0);
}

function changeQty(productId, delta) {
  var item = cart.find(function(i) { return i.id === productId; });
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(function(i) { return i.id !== productId; });
  updateCartBadge();
  renderCartItems();
}

function removeFromCart(productId) {
  cart = cart.filter(function(i) { return i.id !== productId; });
  updateCartBadge();
  renderCartItems();
}

function renderCartItems() {
  var container = document.getElementById('cartItems');
  var totalEl   = document.getElementById('cartTotal');
  if (!container) return;

  if (cart.length === 0) {
    container.innerHTML = '<div class="empty-cart"><div class="icon">&#x1F6D2;</div><p>Seu carrinho est&#xE1; vazio</p></div>';
    if (totalEl) totalEl.textContent = 'R$ 0,00';
    return;
  }

  getProducts().then(function(products) {
    var total = 0;
    container.innerHTML = cart.map(function(item) {
      var p = products.find(function(x) { return x.id === item.id; });
      if (!p) return '';
      var subtotal = p.price * item.qty;
      total += subtotal;
      var imgHtml = p.image
        ? '<img src="' + p.image + '" alt="' + p.name + '" onerror="this.parentElement.innerHTML=\'&#x1F336;&#xFE0F;\'">'
        : '&#x1F336;&#xFE0F;';
      return '<div class="cart-item">' +
        '<div class="cart-item-img">' + imgHtml + '</div>' +
        '<div class="cart-item-info">' +
          '<div class="cart-item-name">' + p.name + '</div>' +
          '<div class="cart-item-price">R$ ' + subtotal.toFixed(2).replace('.', ',') + '</div>' +
          '<div class="qty-controls">' +
            '<button class="qty-btn" onclick="changeQty(' + p.id + ', -1)">&#x2212;</button>' +
            '<span class="qty-val">' + item.qty + '</span>' +
            '<button class="qty-btn" onclick="changeQty(' + p.id + ', 1)">+</button>' +
            '<button class="remove-btn" onclick="removeFromCart(' + p.id + ')">&#x1F5D1;</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');
    if (totalEl) totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
  });
}

/* ════════════════════════════════════
   CHECKOUT
   ════════════════════════════════════ */
function openCheckout() {
  if (cart.length === 0) {
    showToast('Seu carrinho est\u00E1 vazio!');
    return;
  }

  var modal = document.getElementById('checkoutModal');
  var body  = document.getElementById('checkoutBody');
  if (!modal || !body) {
    console.error('Modal de checkout nao encontrado no DOM');
    return;
  }

  getProducts().then(function(products) {
    var total = 0;
    var itemsHtml = cart.map(function(item) {
      var p = products.find(function(x) { return x.id === item.id; });
      if (!p) return '';
      var subtotal = p.price * item.qty;
      total += subtotal;
      return '<div class="order-summary-item">' +
        '<span>' + p.name + ' <strong>x' + item.qty + '</strong></span>' +
        '<span>R$ ' + subtotal.toFixed(2).replace('.', ',') + '</span>' +
        '</div>';
    }).join('');

    body.innerHTML =
      '<div class="order-summary">' +
        itemsHtml +
        '<div class="order-total-row"><span>Total</span><span>R$ ' + total.toFixed(2).replace('.', ',') + '</span></div>' +
      '</div>' +
      '<div class="form-group"><label>Nome Completo *</label><input type="text" id="checkoutName" placeholder="Seu nome completo" autocomplete="name"></div>' +
      '<div class="form-group"><label>Telefone / WhatsApp *</label><input type="tel" id="checkoutPhone" placeholder="(81) 9 XXXX-XXXX" oninput="maskPhone(this)" autocomplete="tel"></div>' +
      '<div class="form-group"><label>Endere\u00E7o de Entrega *</label><input type="text" id="checkoutAddress" placeholder="Rua, n\u00FAmero, bairro, cidade" autocomplete="street-address"></div>' +
      '<div class="form-group"><label>Observa\u00E7\u00F5es</label><input type="text" id="checkoutObs" placeholder="Instru\u00E7\u00F5es especiais..."></div>' +
      '<button class="submit-order-btn" id="submitOrderBtn">Escolher Forma de Pagamento</button>';

    // 1. Fechar carrinho
    closeCart();

    // 2. Abrir modal (z-index 400 garante que fica sobre tudo)
    modal.classList.add('open');

    // 3. Attach no botao de envio sempre fresco (innerHTML recriou o elemento)
    var submitBtn = document.getElementById('submitOrderBtn');
    if (submitBtn) {
      submitBtn.addEventListener('click', choosePaymentMethod);
    }
  });
}

function closeCheckout() {
  document.getElementById('checkoutModal').classList.remove('open');
}

function choosePaymentMethod() {
  var name    = (document.getElementById('checkoutName') || {}).value;
  var phone   = (document.getElementById('checkoutPhone') || {}).value;
  var address = (document.getElementById('checkoutAddress') || {}).value;

  if (!name || !phone || !address) {
    showToast('Preencha todos os campos obrigatorios!');
    return;
  }

  // Guardar dados do cliente em variavel global (para usar depois)
  window.checkoutData = {
    name: name,
    phone: phone,
    address: address,
    obs: (document.getElementById('checkoutObs') || {}).value || ''
  };

  // Mostrar opcoes de pagamento
  var body = document.getElementById('checkoutBody');
  if (!body) return;

  body.innerHTML = 
    '<div style="text-align: center; margin-bottom: 24px;">' +
      '<h3 style="color: var(--marrom); font-family: Playfair Display, serif; font-size: 20px;">Escolha a Forma de Pagamento</h3>' +
    '</div>' +
    '<div class="payment-methods-container">' +
      '<div class="payment-method-card" onclick="selectPaymentMethod(\'pix\')">' +
        '<div class="payment-method-icon">🔐</div>' +
        '<div class="payment-method-name">PIX</div>' +
      '</div>' +
      '<div class="payment-method-card" onclick="selectPaymentMethod(\'dinheiro\')">' +
        '<div class="payment-method-icon">💵</div>' +
        '<div class="payment-method-name">Dinheiro</div>' +
      '</div>' +
      '<div class="payment-method-card" onclick="selectPaymentMethod(\'cartao\')">' +
        '<div class="payment-method-icon">💳</div>' +
        '<div class="payment-method-name">Cartão</div>' +
      '</div>' +
    '</div>';
}

function selectPaymentMethod(method) {
  if (method === 'cartao') {
    showCardConfirmation();
  } else {
    console.log('Forma de pagamento selecionada:', method);
    showToast('Forma de pagamento: ' + method.toUpperCase());
  }
}

function showCardConfirmation() {
  var confirmationHtml = 
    '<div style="text-align: center; padding: 40px 20px;">' +
      '<h3 style="color: var(--marrom); font-family: Playfair Display, serif; font-size: 22px; margin-bottom: 24px;">Você confirma o pagamento com cartão?</h3>' +
      '<div style="display: flex; gap: 16px; justify-content: center;">' +
        '<button onclick="confirmCardPayment()" style="background: var(--vermelho); color: white; border: none; padding: 16px 48px; font-weight: 900; cursor: pointer; border-radius: 4px; font-size: 16px; letter-spacing: 1px;">Confirmar</button>' +
        '<button onclick="cancelCardPayment()" style="background: #ccc; color: var(--marrom); border: none; padding: 16px 48px; font-weight: 900; cursor: pointer; border-radius: 4px; font-size: 16px; letter-spacing: 1px;">Cancelar</button>' +
      '</div>' +
    '</div>';
  
  var body = document.getElementById('checkoutBody');
  if (body) {
    body.innerHTML = confirmationHtml;
  }
}

function confirmCardPayment() {
  submitOrderWithCardPayment();
}

function cancelCardPayment() {
  // Voltar para tela de escolha de pagamento
  choosePaymentMethod();
}

function submitOrderWithCardPayment() {
  var btn = document.getElementById('checkoutBody');
  var name = window.checkoutData.name;
  var phone = window.checkoutData.phone;
  var address = window.checkoutData.address;
  var obs = window.checkoutData.obs;

  if (btn) { 
    var buttons = btn.querySelectorAll('button');
    buttons.forEach(function(b) { b.disabled = true; });
  }

  getProducts().then(function(products) {
    var total = 0;
    var orderItems = cart.map(function(item) {
      var p = products.find(function(x) { return x.id === item.id; });
      if (!p) return null;
      var subtotal = p.price * item.qty;
      total += subtotal;
      return { id: item.id, qty: item.qty, price: p.price, name: p.name };
    }).filter(Boolean);

    if (orderItems.length === 0) {
      showToast('Erro: Nenhum produto válido no carrinho');
      if (btn) { 
        var buttons = btn.querySelectorAll('button');
        buttons.forEach(function(b) { b.disabled = false; });
      }
      return;
    }

    var orderData = {
      customer: { name: name, email: '', phone: phone, cpf: '', address: address },
      items: orderItems,
      subtotal: total,
      frete: 0,
      total: total,
      payment: 'Cartão',
      status: 'Pendente',
      paymentStatus: 'Pendente'
    };

    fetch(API_URL + '/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    })
    .then(function(response) {
      if (!response.ok) {
        return response.json().catch(function() { return {}; }).then(function(err) {
          throw new Error(err.error || ('Erro ' + response.status + ' ao salvar pedido'));
        });
      }
      return response.json();
    })
    .then(function(orderResult) {
      var lines = orderItems.map(function(item) {
        return '• ' + item.name + ' x' + item.qty + ' = R$ ' + (item.price * item.qty).toFixed(2).replace('.', ',');
      }).join('\n');

      var whatsappMsg = '🌶️ *NOVO PEDIDO - Cia de Condimentos*\n\n' +
        '👤 *Cliente:* ' + name + '\n' +
        '📱 *Telefone:* ' + phone + '\n' +
        '📍 *Endereço:* ' + address + '\n' +
        (obs ? '📝 *Obs:* ' + obs + '\n' : '') +
        '\n*Itens:*\n' + lines + '\n\n' +
        '💰 *Total: R$ ' + total.toFixed(2).replace('.', ',') + '*\n\n' +
        '*Pedido #' + orderResult.id + '*';

      showOrderSuccess(orderResult.id, whatsappMsg);
      cart = [];
      updateCartBadge();
    })
    .catch(function(error) {
      console.error('Erro ao enviar pedido:', error);
      showToast('Erro: ' + error.message);
      if (btn) { 
        var buttons = btn.querySelectorAll('button');
        buttons.forEach(function(b) { b.disabled = false; });
      }
    });
  });
}

function showOrderSuccess(orderId, whatsappMsg) {
  var body = document.getElementById('checkoutBody');
  if (!body) return;

  var safeMsg = whatsappMsg
    .replace(/'/g, '&#39;')
    .replace(/\n/g, '\\n');

  var successHtml = 
    '<div style="text-align: center; padding: 40px 20px;">' +
      '<div style="font-size: 48px; margin-bottom: 20px;">✓</div>' +
      '<h3 style="color: var(--vermelho); font-family: Playfair Display, serif; font-size: 24px; margin-bottom: 12px;">Pedido Finalizado com Sucesso!</h3>' +
      '<p style="color: #666; font-size: 16px; margin-bottom: 24px;">Número do Pedido:</p>' +
      '<div style="background: #fdf8ee; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 2px solid var(--amarelo);">' +
        '<p style="font-size: 32px; font-weight: 900; color: var(--vermelho);">#' + orderId + '</p>' +
      '</div>' +
      '<p style="color: #666; font-size: 14px; margin-bottom: 20px;"><em>Guarde este número para acompanhar seu pedido</em></p>' +
      '<button onclick="sendOrderViaWhatsapp(\'' + safeMsg + '\')" style="width: 100%; background: #25D366; color: white; border: none; padding: 16px; font-weight: 900; cursor: pointer; border-radius: 4px; font-size: 16px; letter-spacing: 1px; margin-bottom: 12px;">📱 Enviar Pedido pelo WhatsApp</button>' +
      '<p style="color: #999; font-size: 12px; margin-bottom: 12px;">(Opcional - para reforçar o pedido)</p>' +
      '<button onclick="finishCheckout()" style="width: 100%; background: var(--marrom); color: white; border: none; padding: 16px; font-weight: 700; cursor: pointer; border-radius: 4px; font-size: 16px; letter-spacing: 1px;">Finalizar</button>' +
    '</div>';

  body.innerHTML = successHtml;
}

function sendOrderViaWhatsapp(msg) {
  window.open('https://wa.me/5581971132776?text=' + encodeURIComponent(msg), '_blank');
}

function finishCheckout() {
  closeCheckout();
  showToast('Obrigado pela sua compra!');
}

function submitOrder() {
  var btn     = document.getElementById('submitOrderBtn');
  var name    = (document.getElementById('checkoutName') || {}).value;
  var phone   = (document.getElementById('checkoutPhone') || {}).value;
  var address = (document.getElementById('checkoutAddress') || {}).value;
  var obs     = (document.getElementById('checkoutObs') || {}).value;

  if (name) name = name.trim();
  if (phone) phone = phone.trim();
  if (address) address = address.trim();
  if (obs) obs = obs.trim();

  if (!name || !phone || !address) {
    showToast('Preencha todos os campos obrigat\u00F3rios!');
    return;
  }

  if (btn) { btn.disabled = true; btn.textContent = 'Enviando...'; }

  getProducts().then(function(products) {
    var total = 0;
    var orderItems = cart.map(function(item) {
      var p = products.find(function(x) { return x.id === item.id; });
      if (!p) return null;
      var subtotal = p.price * item.qty;
      total += subtotal;
      return { id: item.id, qty: item.qty, price: p.price, name: p.name };
    }).filter(Boolean);

    if (orderItems.length === 0) {
      showToast('Erro: Nenhum produto v\u00E1lido no carrinho');
      if (btn) { btn.disabled = false; btn.textContent = 'Confirmar Pedido via WhatsApp'; }
      return;
    }

    var orderData = {
      customer: { name: name, email: '', phone: phone, cpf: '', address: address },
      items: orderItems,
      subtotal: total,
      frete: 0,
      total: total,
      payment: 'WhatsApp',
      status: 'Pendente',
      paymentStatus: 'Aguardando'
    };

    fetch(API_URL + '/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    })
    .then(function(response) {
      if (!response.ok) {
        return response.json().catch(function() { return {}; }).then(function(err) {
          throw new Error(err.error || ('Erro ' + response.status + ' ao salvar pedido'));
        });
      }
      return response.json();
    })
    .then(function(orderResult) {
      var lines = orderItems.map(function(item) {
        return '\u2022 ' + item.name + ' x' + item.qty + ' = R$ ' + (item.price * item.qty).toFixed(2).replace('.', ',');
      }).join('\n');

      var msg = '\uD83C\uDF36\uFE0F *NOVO PEDIDO - Cia de Condimentos*\n\n' +
        '\uD83D\uDC64 *Cliente:* ' + name + '\n' +
        '\uD83D\uDCF1 *Telefone:* ' + phone + '\n' +
        '\uD83D\uDCCD *Endere\u00E7o:* ' + address + '\n' +
        (obs ? '\uD83D\uDCDD *Obs:* ' + obs + '\n' : '') +
        '\n*Itens:*\n' + lines + '\n\n' +
        '\uD83D\uDCB0 *Total: R$ ' + total.toFixed(2).replace('.', ',') + '*\n\n' +
        '*Pedido #' + orderResult.id + '*';

      window.open('https://wa.me/5581999999999?text=' + encodeURIComponent(msg), '_blank');

      cart = [];
      updateCartBadge();
      closeCheckout();
      showToast('Pedido enviado via WhatsApp!');
    })
    .catch(function(error) {
      console.error('Erro ao enviar pedido:', error);
      showToast('Erro: ' + error.message);
      if (btn) { btn.disabled = false; btn.textContent = 'Confirmar Pedido via WhatsApp'; }
    });
  });
}

/* ════════════════════════════════════
   PRODUTOS
   ════════════════════════════════════ */
function getProducts() {
  var controller = new AbortController();
  var timeout = setTimeout(function() { controller.abort(); }, 10000);
  return fetch(API_URL + '/products', {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' },
    signal: controller.signal
  })
  .then(function(response) {
    clearTimeout(timeout);
    if (response.ok) {
      return response.json().then(function(products) {
        return products.map(function(p) { return Object.assign({}, p, { price: parseFloat(p.price) || 0 }); });
      });
    }
    throw new Error('Response not ok');
  })
  .catch(function(e) {
    clearTimeout(timeout);
    if (e.name === 'AbortError') {
      showToast('Servidor demorando. Verifique sua conex\u00E3o.');
    } else {
      showToast('Erro ao carregar produtos. Tente novamente.');
    }
    return [];
  });
}

function renderProducts() {
  getProducts().then(function(products) {
    var filtered = products.filter(function(p) {
      return p.active && (currentFilter === 'all' || p.category === currentFilter);
    });
    if (currentSearch) {
      filtered = filtered.filter(function(p) {
        return p.name.toLowerCase().indexOf(currentSearch) !== -1 ||
          (p.description || '').toLowerCase().indexOf(currentSearch) !== -1;
      });
    }

    var grid = document.getElementById('productsGrid');
    if (!grid) return;

    if (filtered.length === 0) {
      grid.innerHTML = '<div class="no-products">Nenhum produto encontrado.</div>';
      return;
    }

    grid.innerHTML = filtered.map(function(p) {
      var imgHtml = p.image
        ? '<img src="' + p.image + '" alt="' + p.name + '" onerror="this.parentElement.innerHTML=\'&#x1F336;&#xFE0F;\'">'
        : '&#x1F336;&#xFE0F;';
      return '<div class="product-card">' +
        '<div class="product-img">' + imgHtml + '</div>' +
        '<div class="product-body">' +
          '<div class="product-category">' + (p.category || '') + '</div>' +
          '<div class="product-name">' + p.name + '</div>' +
          '<div class="product-desc">' + (p.description || '') + '</div>' +
          '<div class="product-stock">Estoque: ' + p.stock + ' unidades</div>' +
          '<div class="product-footer">' +
            '<div class="product-price">R$ ' + p.price.toFixed(2).replace('.', ',') + '</div>' +
            '<button class="add-cart-btn" onclick="addToCart(' + p.id + ')" ' + (p.stock === 0 ? 'disabled' : '') + '>' +
              (p.stock === 0 ? 'Esgotado' : 'Adicionar') +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');
  });
}

function filterProducts(category, btn) {
  currentFilter = category;
  document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  renderProducts();
}

function handleSearch(val) {
  currentSearch = val.toLowerCase();
  renderProducts();
}

/* ════════════════════════════════════
   UTILITARIOS
   ════════════════════════════════════ */
function maskPhone(input) {
  var v = input.value.replace(/\D/g, '').slice(0, 11);
  if (v.length <= 2)      input.value = v.length ? '(' + v : v;
  else if (v.length <= 7) input.value = '(' + v.slice(0,2) + ') ' + v.slice(2);
  else                    input.value = '(' + v.slice(0,2) + ') ' + v.slice(2,7) + '-' + v.slice(7);
}

function showToast(msg) {
  var t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}
</script>
</body>
</html>
